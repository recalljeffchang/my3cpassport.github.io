<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.H. OPERATOR PROTOCOL (v45 GAMIFIED)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --df-gold: #f0b90b;
            --df-gold-glow: rgba(240, 185, 11, 0.6);
            --df-dark: #050505;
            --df-panel: #111;
            --df-gray: #333;
            --df-text: #e0e0e0;
            --df-red: #ff3333;
            --df-red-glow: rgba(255, 51, 51, 0.6);
            --df-cyan: #00f3ff;
            --scanline-color: rgba(0, 0, 0, 0.5);
        }

        /* CRT Effect Overlay */
        .crt::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--df-dark);
            color: var(--df-text);
            margin: 0; padding: 0;
            overflow-x: hidden;
            /* Hexagon Background */
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        /* Boot Screen */
        #bootScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; font-family: 'Share Tech Mono', monospace;
            color: var(--df-gold);
        }
        .boot-text { font-size: 1.2rem; margin-bottom: 10px; opacity: 0; animation: fadeIn 0.2s forwards; }

        .container { max-width: 700px; margin: 0 auto; padding: 20px; padding-bottom: 120px; position: relative; z-index: 1; opacity: 0; transition: opacity 1s; }

        /* HUD Header */
        .hud-header {
            border: 1px solid var(--df-gray); border-top: 4px solid var(--df-gold);
            background: rgba(20, 20, 20, 0.9); padding: 15px; margin-bottom: 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 0 15px rgba(240, 185, 11, 0.1);
        }
        .rank-badge {
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .rank-title { font-size: 0.7rem; color: #888; letter-spacing: 2px; }
        .rank-name { font-size: 1.5rem; font-weight: 700; color: var(--df-gold); text-shadow: 0 0 10px var(--df-gold-glow); }
        .rank-xp { font-size: 0.8rem; font-family: 'Share Tech Mono'; color: var(--df-cyan); }

        /* Progress Circle/Bar */
        .hud-stats { text-align: right; }
        .big-score { font-size: 2.5rem; font-weight: bold; line-height: 1; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); transition: transform 0.2s; }
        .big-score.pulse { transform: scale(1.3); color: var(--df-gold); }

        /* Cards with interaction */
        .card {
            background: rgba(20, 20, 20, 0.8); border: 1px solid var(--df-gray);
            margin-bottom: 15px; padding: 20px; position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }
        .card:hover { border-color: var(--df-gold); box-shadow: 0 0 15px rgba(240, 185, 11, 0.15); transform: translateY(-2px); }
        .card.locked { filter: grayscale(1) blur(2px); opacity: 0.5; pointer-events: none; }

        .card-title {
            font-size: 1.1rem; color: var(--df-gold); margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px dashed #333; padding-bottom: 8px;
        }

        /* Gamified Checkbox */
        .task-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; margin-bottom: 5px; background: #0a0a0a; border: 1px solid #222;
            transition: 0.2s; cursor: pointer;
        }
        .task-item:hover { background: #151515; border-color: #444; }
        .task-item.active { border-color: var(--df-gold); background: rgba(240, 185, 11, 0.05); }
        
        /* Hidden real checkbox, custom UI */
        .g-checkbox {
            width: 20px; height: 20px; border: 2px solid #555; display: inline-block;
            margin-right: 15px; position: relative; transition: 0.2s;
        }
        .task-item.active .g-checkbox {
            background: var(--df-gold); border-color: var(--df-gold); box-shadow: 0 0 10px var(--df-gold);
        }

        /* Inputs */
        input, select {
            background: #080808; border: 1px solid #444; color: #fff; padding: 10px;
            font-family: 'Chakra Petch'; font-size: 1rem; width: 100%; box-sizing: border-box;
            transition: 0.3s;
        }
        input:focus { border-color: var(--df-cyan); outline: none; box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }

        /* Buttons */
        .btn-game {
            background: #222; color: #fff; border: 1px solid #444; padding: 12px;
            font-family: 'Chakra Petch'; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
            position: relative; overflow: hidden;
        }
        .btn-game::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: 0.5s;
        }
        .btn-game:hover::before { left: 100%; }
        .btn-game:hover { border-color: var(--df-gold); color: var(--df-gold); }
        
        .btn-primary { 
            background: var(--df-gold); color: #000; border: none; width: 100%; 
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-primary:hover { background: #fff; color: #000; box-shadow: 0 0 20px var(--df-gold); }

        /* XP Bar */
        .xp-bar-container { height: 6px; background: #222; margin-top: 5px; width: 100%; position: relative; overflow: hidden;}
        .xp-bar-fill { height: 100%; background: var(--df-cyan); width: 0%; transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 10px var(--df-cyan); }

        /* Badges & Tags */
        .badge { font-size: 0.7rem; padding: 2px 6px; border: 1px solid; border-radius: 2px; }
        .badge-bonus { color: var(--df-cyan); border-color: var(--df-cyan); }
        .badge-penalty { color: var(--df-red); border-color: var(--df-red); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }

        /* Floating Info */
        .floating-text {
            position: fixed; color: var(--df-gold); font-weight: bold; pointer-events: none;
            animation: floatUp 1s forwards; z-index: 9999; font-size: 1.2rem; text-shadow: 0 0 5px #000;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        .toolbar { display: flex; gap: 5px; margin-bottom: 15px; }
        .toolbar button { flex: 1; font-size: 0.8rem; }

        /* Mute Button */
        #muteBtn { position: fixed; bottom: 20px; right: 20px; z-index: 100; background: #000; border: 1px solid #333; color: #666; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; }
        #muteBtn:hover { opacity: 1; border-color: var(--df-gold); color: var(--df-gold); }

    </style>
</head>
<body class="crt">

<!-- Boot Screen -->
<div id="bootScreen">
    <div class="boot-text" style="animation-delay: 0.2s">> SYSTEM INITIALIZING...</div>
    <div class="boot-text" style="animation-delay: 0.8s">> LOADING ASSETS...</div>
    <div class="boot-text" style="animation-delay: 1.5s">> CONNECTING TO SERVER...</div>
    <div class="boot-text" style="animation-delay: 2.2s; color:var(--df-cyan)">> ACCESS GRANTED</div>
    <div class="boot-text" style="animation-delay: 2.5s; font-size: 0.8rem; margin-top:20px;">TOUCH TO START</div>
</div>

<div class="container" id="mainUI">
    <!-- Header with Rank -->
    <div class="hud-header">
        <div class="rank-badge">
            <span class="rank-title">OPERATOR RANK</span>
            <span class="rank-name" id="rankName">ROOKIE</span>
            <span class="rank-xp">TOTAL XP: <span id="totalXP">0</span></span>
            <div class="xp-bar-container" style="width: 150px; margin-top: 5px;">
                <div class="xp-bar-fill" id="rankProgress" style="background: var(--df-gold);"></div>
            </div>
        </div>
        <div class="hud-stats">
            <div style="font-size: 0.8rem; color: #888;">DAILY MERITS</div>
            <div class="big-score" id="scoreDisplay">0</div>
            <div style="font-size: 0.8rem; color: #666;">TARGET: 6</div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="btn-game" onclick="setMode('weekday')">üìÖ WEEKDAY</button>
        <button class="btn-game" onclick="setMode('weekend')">‚öΩ WEEKEND</button>
        <button class="btn-game" onclick="saveDraft()">üíæ SAVE</button>
        <button class="btn-game" onclick="clearForm()">üóëÔ∏è RESET</button>
    </div>

    <!-- Progress Bar -->
    <div style="margin-bottom: 20px;">
        <div class="xp-bar-container" style="height: 12px; border: 1px solid #333;">
            <div class="xp-bar-fill" id="dailyProgress"></div>
        </div>
    </div>

    <!-- Cards Container -->
    <div id="gameContent">
        
        <!-- ACADEMIC CARD -->
        <div class="card">
            <div class="card-title">üìö ACADEMIC (Â≠∏Ê•≠)</div>
            
            <div class="task-item" onclick="toggleTask('mathPassed', 2)">
                <div style="display:flex; align-items:center;">
                    <div class="g-checkbox"></div>
                    <span>MATH PASSED</span>
                </div>
                <span class="badge badge-bonus">+2 XP</span>
                <input type="checkbox" id="mathPassed" style="display:none;">
            </div>

            <div class="task-item" style="cursor: default;">
                <div style="display:flex; align-items:center; width: 100%;">
                    <span>üìù OTHER PASS (+1)</span>
                    <input type="number" id="otherExams" value="0" min="0" oninput="sfx.play('blip'); checkStatus()" style="width: 60px; margin-left: auto; text-align: center;">
                </div>
            </div>

             <div class="task-item" style="cursor: default; margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <div style="flex:1; margin-right:5px;">
                        <span style="font-size:0.7rem; color:var(--df-red);">FAILED</span>
                        <input type="number" id="failedExams" value="0" min="0" oninput="sfx.play('error'); checkStatus()" style="border-color:var(--df-red); color:var(--df-red);">
                    </div>
                    <div style="flex:1; margin-left:5px;">
                        <span style="font-size:0.7rem; color:var(--df-gold);">ELITE (>80)</span>
                        <input type="number" id="score80Exams" value="0" min="0" oninput="sfx.play('success'); checkStatus()" style="border-color:var(--df-gold); color:var(--df-gold);">
                    </div>
                </div>
            </div>
        </div>

        <!-- OPS LIST -->
        <div class="card">
            <div class="card-title"><span id="listTitle">TACTICAL OPS</span></div>
            <div id="taskList"></div>
        </div>

        <!-- EQUIPMENT -->
        <div class="card">
            <div class="card-title">üì± EQUIPMENT LOGS</div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="appName" placeholder="APP / GAME" style="flex:2">
                <input type="number" id="appDuration" placeholder="MIN" style="flex:1">
            </div>
            <button class="btn-game" style="width:100%; border-color:var(--df-cyan); color:var(--df-cyan);" onclick="addAppLog()">+ LOG ENTRY</button>
            <div id="appLogList" style="margin-top:10px; font-size:0.85rem; color:#aaa;"></div>
        </div>

        <!-- PENALTIES -->
        <div class="card" style="border-left: 2px solid var(--df-red);">
             <div class="card-title" style="color:var(--df-red)">‚ö†Ô∏è INFRACTIONS</div>
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                 <span>DELAY (MINS)</span>
                 <input type="number" id="overtimeMinutes" value="0" oninput="checkStatus()" style="width:80px; border-color:var(--df-red);">
             </div>
             <div style="display:flex; justify-content:space-between; align-items:center;">
                 <span>VIOLATION (TIMES)</span>
                 <input type="number" id="excessiveCount" value="0" oninput="checkStatus()" style="width:80px; border-color:var(--df-red);">
             </div>
        </div>

        <button id="btnSave" class="btn-game btn-primary" style="margin-top:20px; font-size:1.2rem;" onclick="submitReport()">
            üìù SUBMIT & SYNC
        </button>

        <div id="resultArea" style="margin-top:20px; text-align:center; font-family:'Share Tech Mono'; display:none;"></div>
    </div>
</div>

<button id="muteBtn" onclick="toggleMute()">üîä</button>

<!-- PDF Template (Hidden) -->
<div id="pdfTemplate" style="display:none; font-family:sans-serif; padding:20px;">
    <h1>S.H. OPERATOR LOG</h1>
    <p id="pdfContent"></p>
</div>

<script>
    // --- 1. Audio System (Web Audio API) ---
    class SoundFX {
        constructor() {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.muted = false;
        }

        play(type) {
            if (this.muted) return;
            if (this.ctx.state === 'suspended') this.ctx.resume();
            
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            const now = this.ctx.currentTime;
            
            if (type === 'hover') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.05);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            } 
            else if (type === 'click') { // Checkbox check
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
            else if (type === 'blip') { // Input typing
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.03);
                osc.start(now); osc.stop(now + 0.03);
            }
            else if (type === 'success') { // Task complete
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                osc.frequency.linearRampToValueAtTime(1500, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
            else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }
    }
    const sfx = new SoundFX();
    function toggleMute() {
        sfx.muted = !sfx.muted;
        document.getElementById('muteBtn').innerText = sfx.muted ? 'üîá' : 'üîä';
    }

    // --- 2. Rank System ---
    const RANKS = [
        { xp: 0, name: "ROOKIE (Êñ∞ÂÖµ)", color: "#fff" },
        { xp: 50, name: "PRIVATE (‰∫åÂÖµ)", color: "#ddd" },
        { xp: 150, name: "SPECIALIST (‰∏äÁ≠âÂÖµ)", color: "#ccc" },
        { xp: 300, name: "CORPORAL (‰∏ãÂ£´)", color: "#aaddff" },
        { xp: 500, name: "SERGEANT (‰∏≠Â£´)", color: "#55aaff" },
        { xp: 800, name: "LIEUTENANT (Â∞âÂÆò)", color: "#f0b90b" },
        { xp: 1200, name: "COMMANDER (ÊåáÊèÆÂÆò)", color: "#ff3333" }
    ];

    let totalXP = parseInt(localStorage.getItem('senhuai_total_xp_v45') || '0');

    function updateRankDisplay() {
        let currentRank = RANKS[0];
        let nextRankXP = 50;
        
        for (let i = 0; i < RANKS.length; i++) {
            if (totalXP >= RANKS[i].xp) {
                currentRank = RANKS[i];
                nextRankXP = RANKS[i+1] ? RANKS[i+1].xp : totalXP * 1.5;
            }
        }

        document.getElementById('rankName').innerText = currentRank.name;
        document.getElementById('rankName').style.color = currentRank.color;
        document.getElementById('totalXP').innerText = totalXP;

        // Rank Progress Bar (Current XP towards Next Rank)
        let prevRankXP = 0;
        const rankIndex = RANKS.indexOf(currentRank);
        if(rankIndex > 0) prevRankXP = RANKS[rankIndex].xp;
        
        const progress = Math.min(100, ((totalXP - prevRankXP) / (nextRankXP - prevRankXP)) * 100);
        document.getElementById('rankProgress').style.width = progress + '%';
    }

    // --- 3. Logic & Game Loop ---
    const baseTasks = {
        weekday: [
            { id: 'w1', text: 'üìñ STUDY (ËÆÄÊõ∏ 1hr)', pts: 1 },
            { id: 'w2', text: 'üí§ SLEEP (Áù°Áú† 7.5hr)', pts: 1 },
            { id: 'w3', text: 'üç± LUNCH BOX (Ê¥ó‰æøÁï∂)', pts: 1 },
            { id: 'w4', text: 'üöø SHOWER (Ê¥óÊæ°)', pts: 1 },
            { id: 'w5', text: 'üçΩÔ∏è DISHES (Ê¥óÁ¢ó)', pts: 1 },
            { id: 'w6', text: 'üóëÔ∏è TRASH (ÂûÉÂúæ)', pts: 1 }
        ],
        weekend: [
            { id: 'e1', text: '‚öΩ OUTDOOR (ÈÅãÂãï 1hr)', pts: 1 },
            { id: 'e2', text: 'üçö MEALS (Ê≠£Â∏∏‰∏âÈ§ê)', pts: 1 },
            { id: 'e3', text: 'üëï CLOSET (Êï¥ÁêÜË°£Ê´É)', pts: 1 },
            { id: 'e4', text: 'üõèÔ∏è ROOM CLEAN (Êï¥ÊΩî)', pts: 1 },
            { id: 'e5', text: 'üß∫ LAUNDRY (ÊäòË°£Êúç)', pts: 1 }
        ]
    };

    let currentMode = 'weekday';
    let appLogs = [];

    // Boot Sequence
    window.onload = function() {
        const bootScreen = document.getElementById('bootScreen');
        bootScreen.addEventListener('click', () => {
            sfx.ctx.resume(); // Ensure Audio Context starts on user gesture
            sfx.play('success');
            bootScreen.style.opacity = '0';
            setTimeout(() => { 
                bootScreen.style.display = 'none'; 
                document.querySelector('.container').style.opacity = '1';
                renderTasks();
                updateRankDisplay();
                loadDraft();
            }, 500);
        });

        // Auto-select mode based on day
        const day = new Date().getDay();
        if(day === 0 || day === 6) currentMode = 'weekend';
    };

    function setMode(mode) {
        currentMode = mode;
        sfx.play('blip');
        renderTasks();
        checkStatus();
    }

    function renderTasks() {
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        const items = currentMode === 'weekday' ? baseTasks.weekday : [...baseTasks.weekday, ...baseTasks.weekend];
        
        items.forEach(t => {
            const div = document.createElement('div');
            div.className = 'task-item';
            div.setAttribute('onclick', `toggleTask('${t.id}', ${t.pts})`);
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="g-checkbox"></div>
                    <span>${t.text}</span>
                </div>
                <span class="badge badge-bonus">+${t.pts}</span>
                <input type="checkbox" id="${t.id}" value="${t.pts}" style="display:none;">
            `;
            list.appendChild(div);
        });
        document.getElementById('listTitle').innerText = currentMode === 'weekday' ? 'DAILY OPS (Êó•Â∏∏)' : 'JOINT OPS (ÂÅáÊó•)';
    }

    function toggleTask(id, pts) {
        const chk = document.getElementById(id);
        const parent = chk.closest('.task-item');
        chk.checked = !chk.checked;
        
        if (chk.checked) {
            parent.classList.add('active');
            sfx.play('click');
            showFloatingText(pts, event.clientX, event.clientY);
        } else {
            parent.classList.remove('active');
            sfx.play('hover'); // simpler sound for uncheck
        }
        checkStatus();
    }

    function showFloatingText(pts, x, y) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = `+${pts} XP`;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function checkStatus() {
        let earned = 0;
        
        // Math
        if(document.getElementById('mathPassed').checked) earned += 2;
        // Others
        earned += (parseInt(document.getElementById('otherExams').value) || 0);
        // Tasks
        document.querySelectorAll('#taskList input[type="checkbox"]:checked').forEach(c => earned += parseInt(c.value));

        // Penalties
        const failed = parseInt(document.getElementById('failedExams').value) || 0;
        const lateMins = parseInt(document.getElementById('overtimeMinutes').value) || 0;
        const violations = parseInt(document.getElementById('excessiveCount').value) || 0;
        
        let penalty = 0;
        // Late calculation
        if (lateMins > 0) {
            if(lateMins < 5) penalty += 1;
            else if(lateMins < 10) penalty += 2;
            else penalty += (2 + Math.ceil((lateMins-10)/5));
        }
        penalty += (violations * 1);

        const finalScore = earned - penalty;
        
        // Update UI
        const scoreDisplay = document.getElementById('scoreDisplay');
        scoreDisplay.innerText = finalScore;
        
        // Pulse effect
        scoreDisplay.classList.remove('pulse');
        void scoreDisplay.offsetWidth; // trigger reflow
        scoreDisplay.classList.add('pulse');

        // Progress Bar
        const pct = Math.min(100, (finalScore / 6) * 100);
        document.getElementById('dailyProgress').style.width = pct + '%';
        document.getElementById('dailyProgress').style.backgroundColor = finalScore >= 6 ? 'var(--df-cyan)' : 'var(--df-gold)';

        return { finalScore, failed };
    }

    // --- 4. App Logging ---
    function addAppLog() {
        const name = document.getElementById('appName').value;
        const dur = document.getElementById('appDuration').value;
        if(!name) return;
        appLogs.push({name, dur});
        renderAppLogs();
        document.getElementById('appName').value = '';
        document.getElementById('appDuration').value = '';
        sfx.play('blip');
    }
    function renderAppLogs() {
        document.getElementById('appLogList').innerHTML = appLogs.map(a => `<div>> ${a.name} (${a.dur}m)</div>`).join('');
    }

    // --- 5. Submission & Rank Up ---
    function submitReport() {
        const status = checkStatus();
        
        if (status.failed > 0 && appLogs.length === 0) {
            Swal.fire({ title:'LOGS MISSING', text:'Failed exams require App Logs.', icon:'warning', background:'#111', color:'#fff' });
            return;
        }

        Swal.fire({
            title: 'CONFIRM UPLOAD?',
            text: `SCORE: ${status.finalScore}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'EXECUTE',
            background: '#111', color: '#fff',
            confirmButtonColor: 'var(--df-gold)'
        }).then((result) => {
            if(result.isConfirmed) {
                // Add to Total XP
                if (status.finalScore > 0) {
                    totalXP += status.finalScore;
                    localStorage.setItem('senhuai_total_xp_v45', totalXP);
                    updateRankDisplay();
                }

                // Effect
                sfx.play('success');
                if(status.finalScore >= 6) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#00f3ff', '#f0b90b'] });
                }

                Swal.fire({ 
                    title: 'DATA SYNCED', 
                    text: `Total XP Updated: ${totalXP}`, 
                    icon: 'success', 
                    background: '#111', color: '#fff' 
                });
                
                // Clear draft
                localStorage.removeItem('senhuai_draft_v45');
            }
        });
    }

    // --- 6. Save/Load Draft ---
    function saveDraft() {
        const data = {
            math: document.getElementById('mathPassed').checked,
            others: document.getElementById('otherExams').value,
            failed: document.getElementById('failedExams').value,
            checked: Array.from(document.querySelectorAll('#taskList input:checked')).map(el => el.id),
            appLogs: appLogs,
            mode: currentMode
        };
        localStorage.setItem('senhuai_draft_v45', JSON.stringify(data));
        sfx.play('blip');
        Swal.fire({title:'GAME SAVED', toast:true, position:'top-end', showConfirmButton:false, timer:1500, background:'#111', color:'#fff', icon:'success'});
    }

    function loadDraft() {
        const saved = localStorage.getItem('senhuai_draft_v45');
        if(saved) {
            const data = JSON.parse(saved);
            if(data.mode) setMode(data.mode);
            if(data.math) toggleTask('mathPassed', 2);
            document.getElementById('otherExams').value = data.others;
            document.getElementById('failedExams').value = data.failed;
            if(data.checked) data.checked.forEach(id => {
                 const el = document.getElementById(id);
                 if(el && !el.checked) toggleTask(id, el.value);
            });
            appLogs = data.appLogs || [];
            renderAppLogs();
            checkStatus();
        }
    }
    
    function clearForm() {
        if(confirm('RESET ALL MISSION DATA?')) {
            localStorage.removeItem('senhuai_draft_v45');
            location.reload();
        }
    }

</script>
</body>
</html>
