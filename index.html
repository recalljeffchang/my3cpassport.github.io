<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£®æ·®æ‰‹æ©Ÿï¼Œå¹³æ¿ï¼Œé›»è¦–ï¼Œé›»è…¦ä½¿ç”¨è¦ç¯„ (v41)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --primary: #546e7a;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --danger: #d32f2f;
            --warning: #ed6c02;
            --success: #198754;
            --btn-blue: #0d6efd;
            --math-color: #1565c0;
            --info-bg: #e3f2fd;
            --info-border: #1976d2;
            --bedtime-bg: #f3e5f5;
            --bedtime-border: #7b1fa2;
            --app-bg: #e0f2f1;
            --app-border: #00897b;
            --lock-gray: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #333;
            padding-bottom: 80px;
            transition: background-color 0.8s ease;
        }

        /* Themes */
        body.theme-level-1 { --primary: #2e7d32; --bg: #e8f5e9; }
        body.theme-level-2 { --primary: #0288d1; --bg: #e1f5fe; }
        body.theme-level-3 { --primary: #7b1fa2; --bg: #f3e5f5; }
        body.theme-level-4 { --primary: #fbc02d; --bg: #fffde7; }

        .container { max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: var(--primary); margin: 0; font-size: 1.5rem; line-height: 1.4; transition: color 0.5s; }
        .header-info { 
            display: inline-flex; justify-content: center; gap: 15px; margin-top: 8px; 
            font-size: 0.9rem; color: #555; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.1);
        }
        .version-tag { font-weight: bold; color: var(--primary); }
        .time-tag { font-family: monospace; font-weight: bold; }

        /* Rule Accordion (New v41) */
        .accordion {
            background-color: #fff;
            color: #444;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1rem;
            font-weight: bold;
            transition: 0.4s;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion.active, .accordion:hover { background-color: #f1f1f1; }
        .accordion:after { content: '\002B'; color: #777; font-weight: bold; float: right; margin-left: 5px; font-size: 1.2rem;}
        .accordion.active:after { content: "\2212"; }
        
        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-radius: 0 0 12px 12px;
            margin-top: -10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .rule-list { list-style-type: none; padding: 0; }
        .rule-list li { margin-bottom: 8px; padding-left: 20px; position: relative; font-size: 0.9rem; line-height: 1.5; }
        .rule-list li::before { content: "â€¢"; position: absolute; left: 0; color: var(--primary); font-weight: bold; }
        .rule-section-title { font-weight: bold; color: var(--primary); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; }

        /* Definition Box */
        .definition-box {
            background-color: rgba(255,255,255,0.8); color: #0d47a1; padding: 8px 15px;
            border-radius: 8px; margin-top: 10px; font-size: 0.95rem; display: inline-block; border: 1px solid #bbdefb;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border-top: 4px solid transparent;
        }
        body.theme-level-1 .card { border-top-color: #2e7d32; }
        body.theme-level-2 .card { border-top-color: #0288d1; }
        body.theme-level-3 .card { border-top-color: #7b1fa2; }
        body.theme-level-4 .card { border-top-color: #fbc02d; }

        .card.locked { opacity: 0.6; pointer-events: none; background-color: #f5f5f5; }
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 8px; }

        /* Toolbar */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-tool {
            flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-save-draft { background-color: #607d8b; }
        .btn-load-draft { background-color: #ff9800; }
        .btn-clear-form { background-color: #9e9e9e; }

        /* Lock Banner */
        #lockBanner {
            background-color: #ffebee; border: 2px solid var(--danger); color: var(--danger);
            padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; display: none; 
        }
        .btn-unlock {
            background-color: var(--danger); color: white; border: none; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 0.9rem;
        }

        /* Rules Box (Deadline) */
        .time-rule-box {
            background-color: rgba(255,243,224, 0.9); border: 1px solid #ffe0b2; color: #e65100;
            padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6;
        }
        .time-rule-box ul { margin: 5px 0 0 20px; padding: 0; }

        /* Progress Bar */
        .progress-container { background-color: #eee; border-radius: 10px; height: 30px; width: 100%; margin-bottom: 20px; overflow: hidden; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .progress-bar { background-color: var(--primary); height: 100%; width: 0%; transition: width 0.5s ease, background-color 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.95rem; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .progress-text { text-align: center; font-size: 1rem; margin-bottom: 5px; font-weight: bold; color: var(--primary); transition: color 0.5s; }

        /* UI Elements */
        .mode-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 12px; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .mode-btn.active { background: var(--primary); color: white; }

        .badge-bonus { background: #bbdefb; color: var(--math-color); border: 1px solid var(--math-color); font-weight: bold; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;}
        .badge-point { background: #fff3e0; color: var(--warning); border: 1px solid var(--warning); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;}
        .badge-penalty { background: #ffebee; color: var(--danger); border: 1px solid var(--danger); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;}
        .badge-required { background: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
        .badge-exempt { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
        
        .bedtime-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .bedtime-bonus { background-color: #f3e5f5; border: 1px solid #e1bee7; }
        .bedtime-penalty { background-color: #fff3e0; border: 1px solid #ffe0b2; }

        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .input-row input[type="text"] { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .input-row input[type="number"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .input-row select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background-color: white; }

        .custom-input-area { background: #f0f7ff; padding: 15px; border-radius: 8px; border: 1px dashed #0d6efd; margin-bottom: 15px; }
        .app-input-area { background: var(--app-bg); padding: 15px; border-radius: 8px; border: 1px dashed var(--app-border); margin-bottom: 15px; }
        .violation-input-area { background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px dashed var(--danger); margin-bottom: 15px; }
        
        .btn-add { background: #0d6efd; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add-app { background: var(--app-border); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width:100%;}
        .btn-add-violation { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        
        .violation-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ffebee; color: var(--danger); }
        .app-item { display: flex; flex-direction: column; gap:5px; padding: 10px; border-bottom: 1px solid #b2dfdb; color: #004d40; }
        .app-item-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .app-item-details { display: flex; gap: 10px; font-size: 0.85rem; color: #00695c; }
        
        .btn-delete { background: none; border: none; cursor: pointer; font-size: 1.2rem; margin-left: 10px; }

        .task-group-title { font-size: 0.9rem; color: #666; background: #eee; padding: 5px 10px; border-radius: 4px; margin-top: 15px; font-weight: bold; }
        .task-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        input[type="checkbox"] { width: 24px; height: 24px; margin-right: 15px; accent-color: var(--primary); cursor: pointer; }
        .task-label { font-size: 1rem; flex: 1; cursor: pointer;}
        
        .rule-desc { font-size: 0.85rem; color: #444; margin-top: 5px; line-height: 1.5; padding: 10px; border-radius: 6px; text-align: justify; }
        .rule-desc.warning { background: #fff3e0; border-left: 4px solid var(--warning); }
        .rule-desc.info { background: var(--info-bg); border-left: 4px solid var(--info-border); }

        .penalty-calc-list { margin: 5px 0 0 20px; padding: 0; font-size: 0.85rem; color: #666; }
        .penalty-input-group { display: flex; gap: 10px; align-items: center; margin-top: 15px;}
        .penalty-input-group input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 8px; width: 60px; font-size: 1rem; text-align: center;}
        
        .exam-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; }
        .exam-row.math { background: #e3f2fd; border: 1px solid #bbdefb; }
        .exam-input-group { display: flex; align-items: center; gap: 5px; }
        .exam-input-group input { width: 50px; padding: 5px; border-radius: 5px; border: 1px solid #ddd; text-align: center; }

        .result-box { background: #fafafa; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; display: none; transition: all 0.3s; }
        .result-box.pass { background: #e8f5e9; border: 2px solid var(--success); color: var(--success); display: block;}
        .result-box.fail { background: #ffebee; border: 2px solid var(--danger); color: var(--danger); display: block;}
        
        .btn-submit { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.3s; }
        .btn-submit.locked { background-color: #aaa; cursor: not-allowed; }
        .btn-submit:active { transform: scale(0.98); }
        
        .csv-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-csv { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-export { background-color: var(--btn-blue); }
        .btn-import { background-color: #6c757d; position: relative; overflow: hidden; }
        .btn-import input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        /* æ­·å²ç´€éŒ„æ¨£å¼ */
        .history-log { font-size: 0.9rem; color: #666; margin-top: 10px; max-height: 350px; overflow-y: auto;}
        .history-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; margin-bottom: 5px;}
        .trophy-icon { font-size: 1.3rem; margin-right: 8px; }
        .history-item.rank-1 { background-color: #fffde7; border: 1px solid #fbc02d; border-left: 5px solid #fbc02d; color: #333; box-shadow: 0 2px 5px rgba(251, 192, 45, 0.2); }
        .history-item.rank-2 { background-color: #f5f5f5; border: 1px solid #9e9e9e; border-left: 5px solid #9e9e9e; color: #333; }
        .history-item.rank-3 { background-color: #ffe0b2; border: 1px solid #ef6c00; border-left: 5px solid #ef6c00; color: #333; }

        /* Certificate Styles */
        .swal-certificate {
            background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
            border: 8px double #D4AF37; padding: 20px; text-align: center;
            font-family: "Times New Roman", serif; color: #333; position: relative;
        }
        .cert-title { font-size: 1.8rem; font-weight: bold; color: #D4AF37; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .cert-body { font-size: 1.1rem; line-height: 1.6; margin: 20px 0; }
        .cert-date { font-size: 1.2rem; font-weight: bold; color: #2e7d32; margin-top: 10px; background: #e8f5e9; display: inline-block; padding: 5px 15px; border-radius: 20px; }
        .cert-icon { font-size: 4rem; margin-bottom: 10px; animation: bounce 2s infinite; }
        .cert-stamp { 
            border: 3px solid #d32f2f; color: #d32f2f; font-weight: bold; padding: 5px 10px; border-radius: 5px; 
            transform: rotate(-10deg); display: inline-block; margin-top: 20px; font-family: sans-serif; letter-spacing: 2px;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }

        /* Parent Auth Styles */
        .parent-auth-area { background: #ffebee; border: 1px dashed var(--danger); padding: 15px; border-radius: 8px; margin-top: 10px; }
        .auth-label { font-weight: bold; color: var(--danger); display: block; margin-bottom: 10px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .pwd-input { width: 100%; padding: 10px; border: 1px solid var(--danger); border-radius: 6px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>æ£®æ·®æ‰‹æ©Ÿï¼Œå¹³æ¿ï¼Œé›»è¦–ï¼Œé›»è…¦ä½¿ç”¨è¦ç¯„</h1>
        <div class="header-info">
            <span class="version-tag">ver 41.0 (Rule Book)</span>
            <span>|</span>
            <span id="liveClock" class="time-tag">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <button class="accordion">ğŸ“œ æŸ¥çœ‹å®Œæ•´è¦ç¯„èˆ‡è¨ˆåˆ†ç´°å‰‡ (é»æ“Šå±•é–‹)</button>
    <div class="panel">
        <div style="padding: 15px 0;">
            <div class="definition-box" style="width:100%; box-sizing:border-box; margin-top:0; margin-bottom:15px;">
                â„¹ï¸ <strong>è¨­å‚™å®šç¾©ï¼š</strong>æœ¬è¦ç¯„çµ±ç¨± <strong>3C</strong> åŒ…å«ï¼šæ‰‹æ©Ÿã€å¹³æ¿ã€é›»è…¦ã€é›»è¦–ã€‚
            </div>

            <div class="rule-section-title">ğŸ•’ å¡«å¯«æˆªæ­¢æ™‚é–“</div>
            <ul class="rule-list">
                <li><strong>é€±æ—¥ è‡³ é€±å››ï¼š</strong>éœ€æ–¼ <strong>æ™šä¸Š 10:30</strong> å‰å®Œæˆå¡«å¯«ä¸¦æäº¤ã€‚</li>
                <li><strong>é€±äº”ã€é€±å…­ï¼š</strong>éœ€æ–¼ <strong>æ™šä¸Š 11:30</strong> å‰å®Œæˆå¡«å¯«ä¸¦æäº¤ã€‚</li>
                <li><span style="color:var(--danger)">è¶…éæ™‚é–“è¡¨å–®å°‡è‡ªå‹•é–å®š</span>ï¼Œéœ€è¼¸å…¥å®¶é•·å¯†ç¢¼è§£é–ã€‚</li>
            </ul>

            <div class="rule-section-title">ğŸ¯ é»æ•¸èˆ‡çå‹µæ©Ÿåˆ¶</div>
            <ul class="rule-list">
                <li><strong>åŸºæœ¬é–€æª»ï¼š</strong>æ¯æ—¥éœ€ç´¯ç© <strong>6 é»</strong> ä»¥ä¸Šï¼Œéš”æ—¥æ–¹å¯ä½¿ç”¨ 3Cã€‚</li>
                <li><strong>æ—¥å¸¸ä»»å‹™ï¼š</strong>æ¯å®Œæˆä¸€é …å¯å¾— 1 é» (å¦‚ï¼šè®€æ›¸1å°æ™‚ã€å¯«åŠŸèª²ã€åšå®¶äº‹ç­‰)ã€‚</li>
                <li><strong>å­¸æ¥­åŠ åˆ†ï¼š</strong>
                    <ul style="margin-top:5px;">
                        <li>æ•¸å­¸åŠæ ¼ï¼š+2 é»</li>
                        <li>å…¶ä»–ç§‘ç›®åŠæ ¼ï¼š+1 é»/ç§‘</li>
                        <li>å¯«è€ƒå·ï¼š+1 é»/å¼µ (è‹¥ >85åˆ† é¡å¤– +2 é»ï¼Œå…± 3 é»)</li>
                    </ul>
                </li>
                <li><strong>å°±å¯¢çå‹µï¼š</strong>ç¡å‰å°‡è¨­å‚™æ”¾å®¢å»³å……é›»ï¼š+1 é»ã€‚</li>
            </ul>

            <div class="rule-section-title">ğŸ“± App ç´€éŒ„å…å¡«è±å…æ¬Š</div>
            <ul class="rule-list">
                <li>è‹¥ç•¶æ—¥ç„¡è€ƒè©¦ä¸åŠæ ¼ï¼Œä¸”ç¬¦åˆä»¥ä¸‹ä»»ä¸€æ¢ä»¶ï¼Œå¯å…å¡« App ä½¿ç”¨ç´€éŒ„ï¼š
                    <ul style="margin-top:5px;">
                        <li>ğŸŒŸ æœ‰ä»»ä¸€ç§‘ç›®è€ƒè©¦åˆ†æ•¸ > 80 åˆ†ã€‚</li>
                        <li>ğŸ† ç•¶æ—¥ç¸½å¾—åˆ†é”åˆ° 9 åˆ† (å«) ä»¥ä¸Šã€‚</li>
                    </ul>
                </li>
                <li>è‹¥æœ‰ä¸åŠæ ¼ç§‘ç›®ï¼ŒApp ç´€éŒ„å¼·åˆ¶å¿…å¡«ã€‚</li>
            </ul>

            <div class="rule-section-title">ğŸš« æ‰£åˆ†èˆ‡ç½°å‰‡</div>
            <ul class="rule-list">
                <li><strong>ç­‰ä¸€ä¸‹æ¢æ¬¾ï¼š</strong>ç¶“å‘ŠçŸ¥å¾Œæœªæ–¼5åˆ†é˜å…§æ”¹å–„ï¼š
                    <ul style="margin-top:5px;">
                        <li>é²å»¶ 5 åˆ†é˜å…§ï¼šæ‰£ 1 é»</li>
                        <li>é²å»¶ 5~10 åˆ†é˜ï¼šæ‰£ 2 é»</li>
                        <li>é²å»¶ >10 åˆ†é˜ï¼šæ¯ 5 åˆ†é˜æ‰£ 3 é» (ç´¯åŠ )</li>
                    </ul>
                </li>
                <li><strong>3C ä½¿ç”¨é•è¦ï¼š</strong>æœªç¶“åŒæ„æˆ–è¶…æ™‚ä½¿ç”¨ä¸”æœªä¼‘æ¯ï¼šæ¯æ¬¡æ‰£ 1 é»ã€‚</li>
                <li><strong>å°±å¯¢é•è¦ï¼š</strong>å°±å¯¢æ™‚é–“æ“…è‡ªä½¿ç”¨ä¸”å‹¸å°ç„¡æ•ˆï¼šæ‰£ 2 é»ã€‚</li>
                <li><strong>é‡å¤§é•è¦ï¼š</strong>ç”±å®¶é•·åˆ¤å®šä¸¦è¼¸å…¥æ‰£åˆ† (éœ€å®¶é•·å¯†ç¢¼)ã€‚</li>
            </ul>
        </div>
    </div>

    <div id="lockBanner">
        <h3 style="margin:0 0 10px 0;">â›” å·²è¶…éç•¶å¤©æœ€æ™šå¡«å¯«æ™‚é–“</h3>
        <p style="margin:0; font-size:0.9rem;" id="lockMessage">ç›®å‰è¡¨å–®å·²é–å®šï¼Œç„¡æ³•é€²è¡Œä»»ä½•æ“ä½œã€‚</p>
        <button class="btn-unlock" onclick="unlockForm()">ğŸ” ç¶“å®¶é•·åŒæ„ï¼Œè§£é–ä¸€æ¬¡</button>
    </div>

    <div id="mainForm">
        <div class="toolbar">
            <button class="btn-tool btn-save-draft" onclick="saveDraft()">ğŸ’¾ æš«å­˜é€²åº¦</button>
            <button class="btn-tool btn-load-draft" onclick="loadDraft(true)">ğŸ“‚ è®€å–æš«å­˜</button>
            <button class="btn-tool btn-clear-form" onclick="clearForm()">ğŸ—‘ï¸ æ¸…ç©ºé‡å¡«</button>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('weekday')">ğŸ“… å¹³æ—¥</button>
            <button class="mode-btn" onclick="setMode('weekend')">âš½ å‡æ—¥</button>
        </div>

        <div class="card">
            <div class="progress-text" id="progressText">ç›®å‰é»æ•¸ï¼š0 / 6</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“š å­¸æ¥­è¡¨ç¾ (é¡å¤–åŠ åˆ†)</div>
            <div class="exam-row math">
                <label style="font-weight:bold; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="mathPassed" onchange="checkStatus()"> ğŸ“ æ•¸å­¸åŠæ ¼
                </label>
                <span class="badge-bonus">+2 é»</span>
            </div>
            <div class="exam-row">
                <div style="font-weight:bold;">ğŸ“ å…¶ä»–ç§‘ç›®åŠæ ¼</div>
                <div class="exam-input-group">
                    <input type="number" id="otherExams" value="0" min="0" oninput="checkStatus()">
                    <span style="font-size:0.9rem;">ç§‘</span>
                </div>
                <div style="font-size:0.8rem; color:#666;">(+1/ç§‘)</div>
            </div>

            <div style="margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
                <div style="font-weight:bold; margin-bottom:5px;">ğŸ“Š ä»Šæ—¥è€ƒè©¦æˆç¸¾</div>
                <div class="exam-row" style="background:#ffebee; border:1px solid #ef9a9a;">
                    <div style="font-weight:bold; color:#d32f2f;">ğŸ“‰ ä¸åŠæ ¼ç§‘ç›®</div>
                    <div class="exam-input-group">
                        <input type="number" id="failedExams" value="0" min="0" oninput="checkStatus()" style="border-color:#d32f2f; color:#d32f2f; font-weight:bold;">
                        <span style="font-size:0.9rem; color:#d32f2f;">ç§‘</span>
                    </div>
                </div>
                <div class="exam-row" style="background:#fffde7; border:1px solid #fff59d;">
                    <div style="font-weight:bold; color:#fbc02d;">ğŸŒŸ >80åˆ†ç§‘ç›®</div>
                    <div class="exam-input-group">
                        <input type="number" id="score80Exams" value="0" min="0" oninput="checkStatus()" style="border-color:#fbc02d; font-weight:bold;">
                        <span style="font-size:0.9rem;">ç§‘</span>
                    </div>
                </div>
                <small style="color:#666; display:block; margin-top:5px;">
                    ğŸ’¡ ä¸åŠæ ¼è€…ï¼ŒApp ç´€éŒ„ç‚º<strong>å¿…å¡«</strong>ã€‚<br>
                    ğŸ’¡ æœ‰ >80åˆ†ä¸”ç„¡ä¸åŠæ ¼ï¼ŒApp ç´€éŒ„å¯<strong>å…å¡«</strong>ã€‚
                </small>
            </div>

            <div class="exam-row" style="flex-direction: column; align-items: stretch; gap: 8px; margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
                <div style="font-weight:bold;">âœï¸ å¯«è€ƒå·ç·´ç¿’</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem;">å®Œæˆä»½æ•¸</span>
                    <div class="exam-input-group">
                        <input type="number" id="testPaperCount" value="0" min="0" oninput="checkStatus()">
                        <span style="font-size:0.9rem;">å¼µ</span>
                        <span class="badge-point">+1/å¼µ</span>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem;">>85åˆ†ä»½æ•¸</span>
                    <div class="exam-input-group">
                        <input type="number" id="testPaperHigh" value="0" min="0" oninput="checkStatus()">
                        <span style="font-size:0.9rem;">å¼µ</span>
                        <span class="badge-bonus">+2/å¼µ</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">âœ¨ è‡ªè¨‚åŠ åˆ†é …ç›®</div>
            <div class="custom-input-area">
                <div class="input-row">
                    <input type="text" id="customName" placeholder="è¼¸å…¥ä»»å‹™åç¨±">
                    <input type="number" id="customPoints" placeholder="é»æ•¸" value="1" min="0">
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:0.9rem; display:flex; align-items:center; color:#d32f2f; font-weight:bold;">
                        <input type="checkbox" id="customRequired"> è¨­ç‚ºä½æ¨™
                    </label>
                    <button class="btn-add" onclick="addCustomTask()">ï¼‹ åŠ å…¥</button>
                </div>
            </div>
            <div id="customTaskList"></div>
        </div>

        <div class="card">
            <div class="card-title">
                <span id="appLogTitle">ğŸ“± ç•¶æ—¥ App ä½¿ç”¨èˆ‡è¨ˆç•« <span class="badge-required" id="appRequiredBadge">(å¿…å¡«)</span></span>
                <button onclick="toggleAppHelp()" style="background:none;border:none;cursor:pointer;font-size:1.1rem;" title="å¦‚ä½•æŸ¥è©¢?">â“</button>
            </div>
            <div id="appHelp" class="help-tip">
                <strong>ğŸ” å¦‚ä½•æŸ¥è©¢ä½¿ç”¨æ™‚é–“ï¼Ÿ</strong><br>
                â€¢ <strong>iOS:</strong> è¨­å®š > è¢å¹•ä½¿ç”¨æ™‚é–“<br>
                â€¢ <strong>Android:</strong> è¨­å®š > æ•¸ä½å¥åº· > å„€è¡¨æ¿<br>
                <small style="color:#d32f2f;">* è«‹ä¾æ“šæ‰‹æ©Ÿé¡¯ç¤ºæ‰‹å‹•è¼¸å…¥ã€‚è‹¥æœªä½¿ç”¨ï¼Œè«‹é»æ“Šã€Œä»Šæ—¥æœªä½¿ç”¨ã€ã€‚</small>
            </div>
            
            <div class="app-input-area">
                <div class="quick-app-btn-group">
                    <span style="font-size:0.8rem; color:#666; align-self:center;">å¿«é€Ÿé¸ï¼š</span>
                    <button class="quick-app-btn" onclick="quickFillApp('YouTube')">YouTube</button>
                    <button class="quick-app-btn" onclick="quickFillApp('Roblox')">Roblox</button>
                    <button class="quick-app-btn" onclick="quickFillApp('Instagram')">Instagram</button>
                    <button class="quick-app-btn" onclick="quickFillApp('TikTok')">TikTok</button>
                    <button class="quick-app-btn" onclick="quickFillApp('å‚³èªªå°æ±º')">å‚³èªªå°æ±º</button>
                    <span style="border-left:1px solid #ccc; margin:0 5px;"></span>
                    <button class="btn-no-use" onclick="addNoUsageLog()">ğŸ˜´ ä»Šæ—¥æœªä½¿ç”¨(ä¸€éµ)</button>
                </div>
                
                <div class="input-row">
                    <select id="appDevice" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ddd; background:white;">
                        <option value="POCO">ğŸ“± POCO</option>
                        <option value="iPad Mini">ğŸ iPad Mini</option>
                        <option value="iPad 6">ğŸ iPad 6</option>
                    </select>
                    <input type="text" id="appName" placeholder="App åç¨±" style="flex:2">
                </div>
                
                <div class="input-row">
                    <input type="number" id="appDuration" placeholder="ä»Šæ—¥å¯¦éš› (åˆ†)" min="0">
                    <input type="number" id="appPlanNext" placeholder="ğŸ“… éš”æ—¥é ä¼° (åˆ†)" min="0" style="background:#fffde7; border-color:#fbc02d;">
                </div>
                <button class="btn-add-app" onclick="addAppLog()">ğŸ“ æ–°å¢ç´€éŒ„èˆ‡è¨ˆç•«</button>
            </div>
            
            <div id="appLogList"></div>
            
            <div style="display:flex; justify-content:space-between; margin-top:15px; border-top:1px solid #b2dfdb; padding-top:10px;">
                <div style="font-size:0.9rem; color:#00695c;">
                    ä»Šæ—¥ç¸½è¨ˆï¼š<span id="totalAppTime" style="font-weight:bold; font-size:1.1rem;">0</span> åˆ†
                </div>
                <div style="font-size:0.9rem; color:#f57f17;">
                    éš”æ—¥ç”³è«‹ï¼š<span id="totalPlanTime" style="font-weight:bold; font-size:1.1rem;">0</span> åˆ†
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span id="listTitle">æ—¥å¸¸ä»»å‹™æ¸…å–®</span>
                <span style="font-size:0.8rem; color:#666">æ¯é … 1 é»</span>
            </div>
            <div id="taskList"></div>
        </div>

        <div class="card" style="border-left: 5px solid #7b1fa2;">
            <div class="card-title" style="color: #7b1fa2;">ğŸŒ™ å°±å¯¢ç®¡ç†èˆ‡çæ‡²</div>
            <div class="bedtime-row bedtime-bonus">
                <label style="font-weight:bold; display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="bedtimeBonus" onchange="checkStatus()"> ğŸ”‹ è¨­å‚™æ”¾å®¢å»³å……é›»
                </label>
                <span class="badge-bonus" style="background:#e1bee7; color:#7b1fa2; border-color:#7b1fa2;">+1 é»</span>
            </div>
            <div class="bedtime-row bedtime-penalty">
                <label style="font-weight:bold; display:flex; align-items:center; gap:5px; cursor:pointer; color:var(--danger);">
                    <input type="checkbox" id="bedtimePenalty" onchange="checkStatus()"> ğŸ›Œ å°±å¯¢æ“…è‡ªä½¿ç”¨
                </label>
                <span class="badge-penalty">-2 é»</span>
            </div>
            <div class="rule-desc warning" style="margin-top:0;">
                å®šç¾©ï¼šæœªç¶“åŒæ„æ–¼å°±å¯¢æ™‚é–“æ“…è‡ªä½¿ç”¨3Cï¼Œä¸”ç¶“å‘ŠçŸ¥å¾Œæœªæ”¹å–„ã€‚
            </div>
        </div>

        <div class="card" style="border-left: 5px solid var(--danger);">
            <div class="card-title" style="color: var(--danger);">ğŸš« ç½°å‰‡èˆ‡é•è¦</div>
            
            <div style="margin-bottom: 20px;">
                <strong>â³ ç­‰ä¸€ä¸‹æ¢æ¬¾ (é²å»¶è™•ç½°)</strong>
                <div class="rule-desc warning">
                    å®šç¾©ï¼šç¶“å®¶é•·å‘ŠçŸ¥ 3C ç”¢å“æœªç¶“åŒæ„æˆ–è¶…æ™‚ä½¿ç”¨ï¼Œä¸”ç¶“å‘ŠçŸ¥å¾Œæœªæ–¼äº”åˆ†é˜å…§æ”¹å–„ã€‚
                </div>
                <div class="penalty-input-group">
                    <label>é•è¦é²å»¶å¹¾åˆ†é˜ï¼Ÿ</label>
                    <input type="number" id="overtimeMinutes" value="0" min="0" oninput="checkStatus()">
                    <span style="font-weight: bold; color: var(--danger);">æ‰£ <span id="penaltyPoints">0</span> é»</span>
                </div>
            </div>

            <hr style="border:0; border-top:1px dashed #ddd; margin: 20px 0;">

            <div style="margin-bottom: 20px;">
                <strong>ğŸ“± 3C ä½¿ç”¨é•è¦ (è¶…æ™‚/æœªç”³è«‹)</strong>
                <div class="rule-desc info">
                    <strong>å®šç¾©ï¼š</strong>æœªç¶“åŒæ„æˆ–ç”³è«‹ï¼Œé€£çºŒä½¿ç”¨è¶…é1å°æ™‚ä¸”æœªä¼‘æ¯10åˆ†é˜ï¼Œç¶“å‘ŠçŸ¥å¾Œä»æœªæ”¹å–„ã€‚
                </div>
                <div class="penalty-input-group" style="justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label>é•è¦æ¬¡æ•¸ï¼š</label>
                        <input type="number" id="excessiveCount" value="0" min="0" oninput="checkStatus()">
                        <span>æ¬¡</span>
                    </div>
                    <span style="font-weight: bold; color: var(--danger);">æ‰£ <span id="excessivePenalty">0</span> é»</span>
                </div>
            </div>

            <hr style="border:0; border-top:1px dashed #ddd; margin: 20px 0;">

            <div>
                <div class="card-title" style="margin-bottom:10px;">ğŸ‘® å®¶é•·ç°½æ ¸ & é‡å¤§é•è¦ (å¿…å¡«)</div>
                <div class="parent-auth-area">
                    <label class="auth-label">è«‹å®¶é•·ç¢ºèªä»Šæ—¥ç‹€æ³ï¼š</label>
                    <div class="radio-group">
                        <label><input type="radio" name="violationStatus" value="none" onclick="toggleViolationInput(false)"> â­• æœ¬æ—¥ç„¡é•è¦</label>
                        <label><input type="radio" name="violationStatus" value="exist" onclick="toggleViolationInput(true)"> âŒ æœ‰ç™¼ç”Ÿé•è¦</label>
                    </div>

                    <div id="violationInputZone" style="display:none; margin-top:15px; border-top:1px dashed #d32f2f; padding-top:10px;">
                        <div class="input-row">
                            <input type="text" id="violationName" placeholder="é•è¦äº‹é … (å¦‚: é ‚å˜´ã€èªªè¬Š)">
                            <input type="number" id="violationPoints" placeholder="æ‰£é»" value="1" min="1">
                        </div>
                        <button class="btn-add-violation" onclick="addMajorViolation()">âš ï¸ å¢åŠ é•è¦æ‰£åˆ†</button>
                        <div id="violationList"></div>
                    </div>

                    <div class="password-zone" style="margin-top:15px;">
                        <label style="font-size:0.9rem; color:#666;">ğŸ” å®¶é•·å¯†ç¢¼ç¢ºèª (å„²å­˜å‰å¿…å¡«)ï¼š</label>
                        <input type="password" id="parentPwd" class="pwd-input" placeholder="è¼¸å…¥å®¶é•·å¯†ç¢¼">
                    </div>
                </div>
            </div>
        </div>

        <div id="resultArea" class="result-box"></div>
        <button id="btnSave" class="btn-submit" onclick="saveRecord()">ğŸ“ å®Œæˆä¸¦å„²å­˜ç´€éŒ„</button>
    </div>

    <div class="card" style="margin-top: 30px;">
        <div class="card-title">æ­·å²ç´€éŒ„ç®¡ç† (æœ€é«˜åˆ†æ¦®è­½æ¦œ ğŸ†)</div>
        <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">é¡¯ç¤ºå‰ 10 ç­† (åŒ…å«æœ€é«˜åˆ†èˆ‡è¿‘æœŸç´€éŒ„)ï¼Œæ‰€æœ‰è³‡æ–™ä»ä¿ç•™å¯åŒ¯å‡ºã€‚</div>
        <div class="csv-actions">
            <button class="btn-csv btn-export" onclick="exportToCSV()">ğŸ“¤ åŒ¯å‡ºå®Œæ•´ CSV</button>
            <button class="btn-csv btn-import">ğŸ“¥ è®€å– CSV<input type="file" id="csvFileInput" accept=".csv" onchange="importFromCSV(this)"></button>
        </div>
        <div id="historyList" class="history-log"></div>
        <button onclick="clearHistory()" style="width:100%; margin-top:10px; padding:8px; background:#fff; border:1px solid #ddd; color:#d32f2f; cursor:pointer;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
    </div>
</div>

<script>
    const PARENT_PWD = "jeffjasmine";

    // --- 1. è³‡æ–™çµæ§‹ ---
    const baseWeekdayTasks = [
        { id: 'w2', text: 'é€£çºŒè®€æ›¸ä¸€å°æ™‚', points: 1 },
        { id: 'w3', text: 'ç¡çœ  (éœ€æ»¿ 7.5 å°æ™‚)', points: 1 },
        { id: 'w4', text: 'åŠŸèª²å¯«å®Œ', points: 1 },
        { id: 'w5', text: 'æ´—ä¾¿ç•¶', points: 1 },
        { id: 'w6', text: 'æ´—æ¾¡ (å€‹äººè¡›ç”Ÿ)', points: 1 },
        { id: 'w8', text: 'æ´—é¤å…·', points: 1 },
        { id: 'w9', text: 'ä¸Ÿç’°ä¿åƒåœ¾', points: 1 }
    ];
    const baseWeekendTasks = [
        { id: 'e1', text: 'æˆ¶å¤–é‹å‹•ä¸€å°æ™‚', points: 1 },
        { id: 'e2', text: 'åƒä¸‰é¤ (ä½œæ¯æ­£å¸¸)', points: 1 },
        { id: 'e3', text: 'æ•´ç†è¡£æ«ƒ', points: 1 },
        { id: 'e4', text: 'åºŠä¸Šæ²’é£Ÿç‰©', points: 1 },
        { id: 'e5', text: 'ä¹é»å‰æ´—æ¾¡', points: 1 },
        { id: 'e6', text: 'æŠ˜è¡£æœ', points: 1 }
    ];
    
    const tasks = { weekday: baseWeekdayTasks, weekend: [...baseWeekendTasks, ...baseWeekendTasks] };
    const TARGET_SCORE = 6; 
    let currentMode = 'weekday';
    let historyData = [];
    let customTasks = [];     
    let majorViolations = []; 
    let appUsageLogs = []; 
    let isFormLocked = false;
    let isUnlockedByParent = false;
    let lastCelebratedScore = 5; 
    let isAppLogRequired = true; 

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        const today = new Date();
        const day = today.getDay();
        const saved = localStorage.getItem('senhuai_history_v41'); // v41
        if (saved) historyData = JSON.parse(saved);

        if (day === 0 || day === 6) setMode('weekend');
        else setMode('weekday');
        
        renderHistory();
        checkDeadline(); 
        updateClock();
        setInterval(updateClock, 1000);

        // Accordion Logic
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                } 
            });
        }

        if(localStorage.getItem('senhuai_draft_v41')) {
            Swal.fire({
                title: 'ç™¼ç¾æš«å­˜æª”', text: "è¼‰å…¥ä¸Šæ¬¡é€²åº¦ï¼Ÿ", icon: 'question',
                showCancelButton: true, confirmButtonText: 'è¼‰å…¥'
            }).then((result) => { if (result.isConfirmed) loadDraft(); });
        }
    };

    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').innerText = now.toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        if(now.getSeconds() === 0) checkDeadline();
    }

    function checkDeadline() {
        const now = new Date();
        const day = now.getDay(); 
        const isLateNight = (day === 5 || day === 6);
        const deadlineHour = isLateNight ? 23 : 22;
        const deadlineMinute = 30;
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();

        let isOverdue = false;
        if (currentHour > deadlineHour) isOverdue = true;
        else if (currentHour === deadlineHour && currentMinute >= deadlineMinute) isOverdue = true;

        if (isOverdue && !isFormLocked && !isUnlockedByParent) lockForm(isLateNight);
    }

    function lockForm(isLateNight) {
        isFormLocked = true;
        document.getElementById('lockBanner').style.display = 'block';
        const deadlineTime = isLateNight ? "23:30" : "22:30";
        document.getElementById('lockMessage').innerHTML = `ä»Šæ—¥æˆªæ­¢æ™‚é–“ç‚º <strong>${deadlineTime}</strong>ã€‚<br>ç›®å‰è¡¨å–®å·²é–å®šï¼Œç„¡æ³•é€²è¡Œæ“ä½œã€‚`;
        document.querySelectorAll('#mainForm .card').forEach(card => card.classList.add('locked'));
        document.getElementById('btnSave').disabled = true;
        document.getElementById('btnSave').classList.add('locked');
        document.getElementById('btnSave').innerText = 'â›” å·²é–å®š (ç„¡æ³•å„²å­˜)';
    }

    function unlockForm() {
        Swal.fire({
            title: 'å®¶é•·è§£é–',
            text: 'è«‹è¼¸å…¥å®¶é•·å¯†ç¢¼ä»¥è§£é™¤æ™‚é–“é–å®š',
            input: 'password',
            inputPlaceholder: 'è¼¸å…¥å¯†ç¢¼',
            showCancelButton: true,
            confirmButtonText: 'è§£é–',
            cancelButtonText: 'å–æ¶ˆ',
            preConfirm: (password) => {
                if (password !== PARENT_PWD) {
                    Swal.showValidationMessage('å¯†ç¢¼éŒ¯èª¤ï¼');
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                isFormLocked = false;
                isUnlockedByParent = true;
                document.getElementById('lockBanner').style.display = 'none';
                document.querySelectorAll('#mainForm .card').forEach(card => card.classList.remove('locked'));
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSave').classList.remove('locked');
                document.getElementById('btnSave').innerText = 'ğŸ“ å®Œæˆä¸¦å„²å­˜ç´€éŒ„';
                Swal.fire('å·²è§£é–', 'è¡¨å–®å·²æš«æ™‚é–‹æ”¾å¡«å¯«', 'success');
            }
        });
    }

    // --- 3. æ ¸å¿ƒæ¸²æŸ“ ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        if(mode === 'weekday') {
            document.querySelectorAll('.mode-btn')[0].classList.add('active');
            document.getElementById('listTitle').innerText = "æ—¥å¸¸ä»»å‹™æ¸…å–®";
            renderTasks(tasks.weekday, false);
        } else {
            document.querySelectorAll('.mode-btn')[1].classList.add('active');
            document.getElementById('listTitle').innerText = "å‡æ—¥ç¶œåˆæ¸…å–®";
            renderTasks([], true);
        }
        checkStatus(); 
    }

    function renderTasks(taskList, showGroups) {
        const container = document.getElementById('taskList');
        container.innerHTML = '';
        if (showGroups) {
            const title1 = document.createElement('div'); title1.className = 'task-group-title'; title1.innerText = 'å¹³æ—¥åŸºç¤'; container.appendChild(title1);
            baseWeekdayTasks.forEach(task => container.appendChild(createTaskElement(task)));
            const title2 = document.createElement('div'); title2.className = 'task-group-title'; title2.innerText = 'å‡æ—¥åŠ ç¢¼'; container.appendChild(title2);
            baseWeekendTasks.forEach(task => container.appendChild(createTaskElement(task))); 
        } else {
            taskList.forEach(task => container.appendChild(createTaskElement(task)));
        }
    }

    function createTaskElement(task) {
        const div = document.createElement('div'); div.className = 'task-item';
        div.innerHTML = `<input type="checkbox" id="${task.id}" value="${task.points}" onchange="checkStatus()"><label for="${task.id}" class="task-label">${task.text}</label><span class="badge-point">+${task.points}é»</span>`;
        return div;
    }

    // --- æš«å­˜ ---
    function saveDraft() {
        if(isFormLocked) { Swal.fire('å·²é–å®š', 'ç„¡æ³•æš«å­˜', 'error'); return; }
        const draft = {
            mathPassed: document.getElementById('mathPassed').checked,
            otherExams: document.getElementById('otherExams').value,
            failedExams: document.getElementById('failedExams').value,
            score80Exams: document.getElementById('score80Exams').value,
            testPaperCount: document.getElementById('testPaperCount').value,
            testPaperHigh: document.getElementById('testPaperHigh').value,
            bedtimeBonus: document.getElementById('bedtimeBonus').checked,
            bedtimePenalty: document.getElementById('bedtimePenalty').checked,
            overtimeMinutes: document.getElementById('overtimeMinutes').value,
            excessiveCount: document.getElementById('excessiveCount').value,
            customTasks, majorViolations, appUsageLogs, checkedTasks: [], customTasksChecked: []
        };
        document.querySelectorAll('#taskList input[type="checkbox"]').forEach(chk => { if(chk.checked) draft.checkedTasks.push(chk.id); });
        customTasks.forEach(t => { if(document.getElementById(t.id).checked) draft.customTasksChecked.push(t.id); });
        localStorage.setItem('senhuai_draft_v41', JSON.stringify(draft)); // v41
        Swal.fire({ icon: 'success', title: 'æš«å­˜æˆåŠŸ', timer: 1500, showConfirmButton: false });
    }

    function loadDraft(showMsg) {
        const saved = localStorage.getItem('senhuai_draft_v41'); // v41
        if(!saved) { if(showMsg) Swal.fire('ç„¡æš«å­˜æª”', '', 'info'); return; }
        const draft = JSON.parse(saved);
        document.getElementById('mathPassed').checked = draft.mathPassed;
        document.getElementById('otherExams').value = draft.otherExams;
        document.getElementById('failedExams').value = draft.failedExams || 0;
        document.getElementById('score80Exams').value = draft.score80Exams || 0;
        document.getElementById('testPaperCount').value = draft.testPaperCount;
        document.getElementById('testPaperHigh').value = draft.testPaperHigh;
        document.getElementById('bedtimeBonus').checked = draft.bedtimeBonus;
        document.getElementById('bedtimePenalty').checked = draft.bedtimePenalty;
        document.getElementById('overtimeMinutes').value = draft.overtimeMinutes;
        document.getElementById('excessiveCount').value = draft.excessiveCount;
        
        customTasks = draft.customTasks || []; 
        majorViolations = draft.majorViolations || []; 
        appUsageLogs = draft.appUsageLogs || [];
        
        renderCustomTasks(); renderMajorViolations(); renderAppLogs();
        
        setTimeout(() => {
            if(draft.checkedTasks) draft.checkedTasks.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
            if(draft.customTasksChecked) draft.customTasksChecked.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
            checkStatus(); 
        }, 50);
        if(showMsg) Swal.fire({ icon: 'success', title: 'è®€å–æˆåŠŸ', timer: 1000, showConfirmButton: false });
    }

    function clearForm() {
        Swal.fire({ title: 'ç¢ºå®šæ¸…ç©ºï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'æ¸…ç©º' }).then((result) => {
            if (result.isConfirmed) { localStorage.removeItem('senhuai_draft_v41'); location.reload(); }
        });
    }

    // --- App Logs ---
    function quickFillApp(appName) {
        document.getElementById('appName').value = appName;
        document.getElementById('appDuration').focus();
    }
    function toggleAppHelp() {
        const help = document.getElementById('appHelp');
        help.style.display = help.style.display === 'block' ? 'none' : 'block';
    }

    function addAppLog() {
        if(isFormLocked) return;
        const device = document.getElementById('appDevice').value;
        const name = document.getElementById('appName').value.trim();
        const duration = parseInt(document.getElementById('appDuration').value) || 0;
        const planNext = parseInt(document.getElementById('appPlanNext').value) || 0;
        
        if (!name) { Swal.fire('è«‹è¼¸å…¥ App', '', 'warning'); return; }
        if (duration < 0 || planNext < 0) { Swal.fire('æ™‚é–“ä¸èƒ½ç‚ºè² ', '', 'warning'); return; }
        
        appUsageLogs.push({ id: 'app_' + Date.now(), device, name, duration, planNext });
        
        document.getElementById('appName').value = '';
        document.getElementById('appDuration').value = '';
        document.getElementById('appPlanNext').value = '';
        renderAppLogs();
    }
    
    function addNoUsageLog() {
        if(isFormLocked) return;
        appUsageLogs.push({ id: 'app_' + Date.now(), device: 'å…¨è£ç½®', name: 'ç„¡ä½¿ç”¨', duration: 0, planNext: 0 });
        renderAppLogs();
    }
    
    function removeAppLog(id) {
        if(isFormLocked) return;
        appUsageLogs = appUsageLogs.filter(app => app.id !== id);
        renderAppLogs();
    }

    function renderAppLogs() {
        const container = document.getElementById('appLogList');
        const totalSpan = document.getElementById('totalAppTime');
        const totalPlanSpan = document.getElementById('totalPlanTime');
        container.innerHTML = '';
        
        let total = 0;
        let totalPlan = 0;
        
        appUsageLogs.forEach(app => {
            total += app.duration;
            totalPlan += app.planNext || 0;
            
            const div = document.createElement('div'); div.className = 'app-item';
            div.innerHTML = `
                <div class="app-item-header">
                    <span><small style="color:#666; font-weight:normal; margin-right:5px;">[${app.device}]</small> ${app.name}</span>
                    <button class="btn-delete" onclick="removeAppLog('${app.id}')">âœ•</button>
                </div>
                <div class="app-item-details">
                    <span>ä»Šæ—¥ï¼š${app.duration}åˆ†</span>
                    <span style="color:#f57f17;">ğŸ“… é ä¼°ï¼š${app.planNext || 0}åˆ†</span>
                </div>
            `;
            container.appendChild(div);
        });
        totalSpan.innerText = total;
        totalPlanSpan.innerText = totalPlan;
    }

    // --- Parent Auth Logic ---
    function toggleViolationInput(show) {
        const zone = document.getElementById('violationInputZone');
        if(show) {
            zone.style.display = 'block';
        } else {
            zone.style.display = 'none';
            majorViolations = []; 
            renderMajorViolations();
            checkStatus();
        }
    }

    function addMajorViolation() {
        if(isFormLocked) return;
        const name = document.getElementById('violationName').value.trim();
        const points = parseInt(document.getElementById('violationPoints').value) || 0;
        if (!name) { Swal.fire('è«‹è¼¸å…¥é•è¦', '', 'warning'); return; }
        majorViolations.push({ id: 'violation_' + Date.now(), text: name, points });
        document.getElementById('violationName').value = ''; document.getElementById('violationPoints').value = 1;
        renderMajorViolations(); checkStatus();
    }
    
    function removeMajorViolation(id) { 
        if(isFormLocked) return; 
        majorViolations = majorViolations.filter(v => v.id !== id); 
        renderMajorViolations(); 
        checkStatus(); 
    }
    
    function renderMajorViolations() {
        const container = document.getElementById('violationList'); container.innerHTML = '';
        majorViolations.forEach(v => {
            const div = document.createElement('div'); div.className = 'violation-item';
            div.innerHTML = `<span>âš ï¸ ${v.text}</span><div style="display:flex; align-items:center;"><span class="badge-penalty">-${v.points}é»</span><button class="btn-delete" style="color:#d32f2f;" onclick="removeMajorViolation('${v.id}')">ğŸ—‘ï¸</button></div>`;
            container.appendChild(div);
        });
    }

    // --- å…¶ä»–é‚è¼¯ ---
    function addCustomTask() {
        if(isFormLocked) return;
        const name = document.getElementById('customName').value.trim();
        const points = parseInt(document.getElementById('customPoints').value) || 0;
        const required = document.getElementById('customRequired').checked;
        if (!name) { Swal.fire('è«‹è¼¸å…¥åç¨±', '', 'warning'); return; }
        customTasks.push({ id: 'custom_' + Date.now(), text: name, points, required });
        document.getElementById('customName').value = ''; document.getElementById('customPoints').value = 1; document.getElementById('customRequired').checked = false;
        renderCustomTasks(); checkStatus();
    }
    function removeCustomTask(id) { if(isFormLocked) return; customTasks = customTasks.filter(t => t.id !== id); renderCustomTasks(); checkStatus(); }
    function renderCustomTasks() {
        const container = document.getElementById('customTaskList'); container.innerHTML = '';
        customTasks.forEach(task => {
            const div = document.createElement('div'); div.className = 'task-item';
            div.innerHTML = `<input type="checkbox" id="${task.id}" value="${task.points}" onchange="checkStatus()"><label for="${task.id}" class="task-label">${task.text} ${task.required ? '<span class="badge-required">ä½æ¨™</span>' : ''}</label><span class="badge-point" style="background:#e3f2fd; color:#1565c0; border-color:#1565c0;">+${task.points}é»</span><button class="btn-delete" onclick="removeCustomTask('${task.id}')">ğŸ—‘ï¸</button>`;
            container.appendChild(div);
        });
    }

    function calculateTimePenalty() {
        const mins = parseInt(document.getElementById('overtimeMinutes').value) || 0;
        let points = 0;
        if (mins < 5 && mins > 0) points = 1; else if (mins >= 5 && mins < 10) points = 2; else if (mins >= 10) points = 2 + (Math.floor((mins - 10) / 5) + 1) * 3;
        document.getElementById('penaltyPoints').innerText = points;
        return points;
    }

    function checkStatus() {
        let earnedScore = 0; 
        let missingRequired = [];

        const failedExams = parseInt(document.getElementById('failedExams').value) || 0;
        const score80Exams = parseInt(document.getElementById('score80Exams').value) || 0;

        if (document.getElementById('mathPassed').checked) earnedScore += 2;
        earnedScore += (parseInt(document.getElementById('otherExams').value) || 0);
        
        const tpCount = parseInt(document.getElementById('testPaperCount').value) || 0;
        const tpHigh = parseInt(document.getElementById('testPaperHigh').value) || 0;
        earnedScore += tpCount * 1; earnedScore += tpHigh * 2;

        document.querySelectorAll('#taskList input[type="checkbox"]:checked').forEach(chk => { earnedScore += parseInt(chk.value); });
        customTasks.forEach(task => {
            const chk = document.getElementById(task.id);
            if (chk && chk.checked) { earnedScore += task.points; } else if (task.required) { missingRequired.push(task.text); }
        });
        if (document.getElementById('bedtimeBonus').checked) earnedScore += 1;

        const timePenalty = calculateTimePenalty();
        const excessiveCount = parseInt(document.getElementById('excessiveCount').value) || 0;
        const excessivePenalty = excessiveCount * 1;
        document.getElementById('excessivePenalty').innerText = excessivePenalty;
        let violationPenalty = 0; majorViolations.forEach(v => violationPenalty += v.points);
        let bedtimePenalty = 0; if (document.getElementById('bedtimePenalty').checked) bedtimePenalty = 2;

        const totalPenalty = timePenalty + excessivePenalty + violationPenalty + bedtimePenalty;
        let finalScore = earnedScore - totalPenalty;

        const badge = document.getElementById('appRequiredBadge');
        if (failedExams > 0) {
            isAppLogRequired = true;
            badge.innerText = '(å¿…å¡« - æœ‰ä¸åŠæ ¼)';
            badge.className = 'badge-required';
        } else if (score80Exams > 0) {
            isAppLogRequired = false;
            badge.innerText = '(å…å¡« âœ¨ - è€ƒ80åˆ†)';
            badge.className = 'badge-exempt';
        } else if (finalScore >= 9) { 
            isAppLogRequired = false;
            badge.innerText = '(å…å¡« âœ¨ - 9åˆ†é”æ¨™)';
            badge.className = 'badge-exempt';
        } else {
            isAppLogRequired = true;
            badge.innerText = '(å¿…å¡«)';
            badge.className = 'badge-required';
        }

        const progressBar = document.getElementById('progressBar');
        const percent = Math.min((earnedScore / TARGET_SCORE) * 100, 100);
        progressBar.style.width = percent + '%';
        
        if (earnedScore >= TARGET_SCORE) {
            progressBar.style.backgroundColor = 'var(--success)';
            document.getElementById('progressText').innerHTML = `åŸå§‹å¾—åˆ†ï¼š${earnedScore} / ${TARGET_SCORE} <span style="color:var(--success)">(é”æ¨™)</span>`;
        } else {
            progressBar.style.backgroundColor = 'var(--warning)';
            document.getElementById('progressText').innerHTML = `åŸå§‹å¾—åˆ†ï¼š${earnedScore} / ${TARGET_SCORE} <span style="color:var(--warning)">(å·® ${Math.max(0, TARGET_SCORE - earnedScore)})</span>`;
        }

        renderResultBox(earnedScore, finalScore, missingRequired, totalPenalty);
        updateTheme(finalScore);
        
        if (finalScore >= TARGET_SCORE && missingRequired.length === 0) {
            if (finalScore > lastCelebratedScore) {
                triggerCelebration(finalScore);
                lastCelebratedScore = finalScore;
            }
        } else {
            if (finalScore < TARGET_SCORE) lastCelebratedScore = TARGET_SCORE - 1;
        }

        return { score: finalScore, earned: earnedScore, passed: (finalScore >= TARGET_SCORE && missingRequired.length === 0), missing: missingRequired, timePenalty, excessivePenalty, violationPenalty, bedtimePenalty, excessiveCount, tpCount, tpHigh, failedExams, score80Exams };
    }

    function updateTheme(score) {
        document.body.className = '';
        if (score >= 9) document.body.classList.add('theme-level-4');
        else if (score >= 8) document.body.classList.add('theme-level-3');
        else if (score >= 7) document.body.classList.add('theme-level-2');
        else if (score >= 6) document.body.classList.add('theme-level-1');
    }

    function triggerCelebration(score) {
        let title = "", icon = "success";
        if (score === 6) { title = "å¤ªæ£’äº†ï¼é»æ•¸å·²é”æ¨™ (6åˆ†)ï¼"; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        else if (score === 7) { title = "å¤ªå¼·äº†ï¼è¶…è¶Šæ¥µé™ (7åˆ†)ï¼"; icon = "info"; confetti({ shapes: ['star'], particleCount: 150, spread: 80, colors: ['#00BFFF', '#1E90FF'] }); }
        else if (score === 8) { 
            title = "ä¸å¯æ€è­°ï¼ä½ æ˜¯è¶…äººå— (8åˆ†)ï¼Ÿ"; icon = "warning"; 
            var end = Date.now() + 1000, colors = ['#bb0000', '#ffffff'];
            (function frame() { confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, colors }); confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, colors }); if (Date.now() < end) requestAnimationFrame(frame); }());
        } 
        else if (score >= 9) { 
            title = "å‚³èªªç´šè¡¨ç¾ï¼å·²ç™»å³°é€ æ¥µ (9åˆ†+)ï¼"; icon = "question"; 
            var duration = 3000, end = Date.now() + duration;
            var interval = setInterval(function() { if (Date.now() > end) return clearInterval(interval); confetti({ particleCount: 50 * ( (end - Date.now()) / duration ), startVelocity: 30, spread: 360, origin: { x: Math.random(), y: Math.random() - 0.2 } }); }, 250);
        }
        Swal.fire({ position: 'top-end', icon, title, showConfirmButton: false, timer: 2500, toast: true, background: 'rgba(255, 255, 255, 0.95)' });
    }

    function renderResultBox(earned, final, missing, totalPenalty) {
        const resultArea = document.getElementById('resultArea');
        resultArea.className = 'result-box';
        let html = '';
        if (final >= TARGET_SCORE && missing.length === 0) {
            resultArea.classList.remove('fail'); resultArea.classList.add('pass');
            html = `<h3>ğŸ‰ æ­å–œé”æ¨™ï¼</h3><p>æœ€çµ‚æœ‰æ•ˆåˆ†æ•¸ï¼š<strong>${final} é»</strong></p><p style="font-size:0.9rem; color:#666;">(åŸå§‹ ${earned} - ç¸½ç½°å‰‡ ${totalPenalty})</p>`;
        } else {
            resultArea.classList.remove('pass'); resultArea.classList.add('fail');
            if (missing.length > 0) html = `<h3>âŒ æœªå®Œæˆä½æ¨™</h3><p>ç¼ºå¿…åšï¼š<br><strong>${missing.join('ã€')}</strong></p>`;
            else html = `<h3>âŒ åˆ†æ•¸ä¸è¶³</h3><p>æœ€çµ‚æœ‰æ•ˆåˆ†æ•¸ï¼š<strong>${final} é»</strong> (ç›®æ¨™ ${TARGET_SCORE})</p><p style="font-size:0.9rem; color:#666;">(åŸå§‹ ${earned} - ç¸½ç½°å‰‡ ${totalPenalty})</p>`;
        }
        if (totalPenalty > 0) html += `<div style="border-top:1px solid #eee; margin-top:10px; padding-top:5px; text-align:left; font-size:0.9rem; color:var(--danger);">âš ï¸ åŒ…å«é•è¦æ‰£åˆ†å…± -${totalPenalty} é»</div>`;
        resultArea.innerHTML = html;
    }

    // --- å„²å­˜ ---
    function saveRecord() {
        if(isFormLocked) { Swal.fire('å·²é–å®š', 'ç„¡æ³•å„²å­˜', 'error'); return; }
        
        // 1. App Log Check
        if (isAppLogRequired && appUsageLogs.length === 0) {
            Swal.fire({ icon: 'warning', title: 'è³‡æ–™ä¸å®Œæ•´', text: 'ä¾ç…§ä»Šæ—¥è€ƒè©¦ç‹€æ³ï¼Œæ‚¨å¿…é ˆå¡«å¯«ã€ŒApp ä½¿ç”¨ç´€éŒ„ã€ï¼', confirmButtonColor: '#d33' });
            return;
        }

        // 2. Parent Auth Check
        const violationStatus = document.querySelector('input[name="violationStatus"]:checked');
        if (!violationStatus) {
            Swal.fire({ icon: 'warning', title: 'å®¶é•·ç°½æ ¸æœªå®Œæˆ', text: 'è«‹åœ¨ã€Œå®¶é•·ç°½æ ¸å€ã€é¸æ“‡ä»Šæ—¥æ˜¯å¦æœ‰é•è¦ï¼', confirmButtonColor: '#d33' });
            document.querySelector('.parent-auth-area').scrollIntoView({behavior: 'smooth'});
            return;
        }

        if (violationStatus.value === 'exist' && majorViolations.length === 0) {
             Swal.fire({ icon: 'error', title: 'è³‡æ–™ä¸ç¬¦', text: 'æ‚¨å‹¾é¸äº†ã€Œæœ‰ç™¼ç”Ÿé•è¦ã€ï¼Œä½†æ²’æœ‰æ–°å¢ä»»ä½•é•è¦é …ç›®ï¼', confirmButtonColor: '#d33' });
             return;
        }

        const pwd = document.getElementById('parentPwd').value;
        if (pwd !== PARENT_PWD) {
            Swal.fire({ icon: 'error', title: 'å¯†ç¢¼éŒ¯èª¤', text: 'å®¶é•·ç°½æ ¸å¯†ç¢¼ä¸æ­£ç¢ºï¼', confirmButtonColor: '#d33' });
            return;
        }
        
        const status = checkStatus();
        const dateStr = new Date().toLocaleString('zh-TW', { hour12: false });
        let resultStr = status.passed ? "âœ…é”æ¨™" : "âŒæœªé”æ¨™";
        if(status.missing.length > 0) resultStr = "âŒç¼ºå¿…åš";
        
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toLocaleDateString('zh-TW');

        if(status.passed) {
            const certHtml = `
                <div class="swal-certificate">
                    <div class="cert-icon">ğŸ†</div>
                    <div class="cert-title">3C è¨­å‚™ä½¿ç”¨æˆæ¬Šæ›¸</div>
                    <div class="cert-body">
                        èŒ²è­‰æ˜ <strong>æ£®æ·®</strong> ä»Šæ—¥è¡¨ç¾å„ªç•°ï¼Œ<br>
                        ç´¯ç©é»æ•¸é”æ¨™ (${status.score}åˆ†)ï¼Œ<br>
                        ç‰¹æ­¤æˆäºˆæ˜æ—¥ 3C è¨­å‚™ä½¿ç”¨æ¬Šé™ã€‚
                    </div>
                    <div class="cert-date">æˆæ¬Šæ—¥æœŸï¼š${tomorrowStr}</div>
                    <div><div class="cert-stamp">VERIFIED âœ…</div></div>
                    <div style="margin-top:20px; font-size:0.8rem; color:#666;">è«‹æˆªåœ–æ­¤ç•«é¢ä¿å­˜</div>
                </div>
            `;
            Swal.fire({ html: certHtml, width: 600, padding: 0, showConfirmButton: true, confirmButtonText: 'å¤ªæ£’äº† (é—œé–‰)', backdrop: `rgba(0,0,0,0.8)` });
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        } else {
            Swal.fire({ title: 'ç´€éŒ„å·²å„²å­˜', text: `ä»Šæ—¥å¾—åˆ†ï¼š${status.score} åˆ†ã€‚`, icon: 'info', timer: 1500, showConfirmButton: false });
        }

        let doneCustoms = []; customTasks.forEach(t => { if(document.getElementById(t.id).checked) doneCustoms.push(t.text); });
        let violations = majorViolations.map(v => `${v.text}(-${v.points})`);
        
        let appLogStr = appUsageLogs.map(a => `[${a.device}]${a.name}(${a.duration}m/é ${a.planNext||0}m)`).join(' | ');

        const record = {
            date: dateStr, mode: currentMode === 'weekday' ? 'å¹³æ—¥' : 'å‡æ—¥',
            finalScore: status.score, result: resultStr,
            earnedScore: status.earned, timePenalty: status.timePenalty, excessivePenalty: status.excessivePenalty,
            violationPenalty: status.violationPenalty, bedtimePenalty: status.bedtimePenalty, 
            bedtimeBonus: document.getElementById('bedtimeBonus').checked ? "æ˜¯" : "å¦", 
            violationDetails: violations.join(" | ") || "ç„¡", math: document.getElementById('mathPassed').checked ? "æ˜¯" : "å¦",
            others: document.getElementById('otherExams').value, customs: doneCustoms.join(" | ") || "ç„¡", excessiveCount: status.excessiveCount,
            tpCount: status.tpCount, tpHigh: status.tpHigh,
            failedExams: status.failedExams, score80Exams: status.score80Exams,
            appLogStr: appLogStr || "ç„¡"
        };
        
        historyData.unshift(record);
        updateStorageAndUI();
        localStorage.removeItem('senhuai_draft_v41'); // v41
        document.getElementById('parentPwd').value = ''; 
    }

    function updateStorageAndUI() { localStorage.setItem('senhuai_history_v41', JSON.stringify(historyData)); renderHistory(); }
    
    function renderHistory() {
        const list = document.getElementById('historyList'); list.innerHTML = '';
        if(historyData.length === 0) { list.innerHTML = '<p style="text-align:center; padding:10px; color:#999;">ç›®å‰å°šç„¡ç´€éŒ„</p>'; return; }
        
        let sorted = [...historyData].sort((a,b) => {
            let sa = parseFloat(a.finalScore), sb = parseFloat(b.finalScore);
            return sb !== sa ? sb - sa : new Date(b.date) - new Date(a.date);
        });
        let top3 = sorted.slice(0,3);
        let rest = historyData.filter(i => !top3.includes(i)).sort((a,b) => new Date(b.date) - new Date(a.date));
        let displayList = [...top3, ...rest.slice(0, 7)];

        displayList.forEach(item => {
            const div = document.createElement('div'); div.className = 'history-item';
            let rank = top3.indexOf(item), trophy = '', rankClass = '';
            if(rank === 0) { trophy = 'ğŸ†'; rankClass = 'rank-1'; }
            else if(rank === 1) { trophy = 'ğŸ¥ˆ'; rankClass = 'rank-2'; }
            else if(rank === 2) { trophy = 'ğŸ¥‰'; rankClass = 'rank-3'; }
            if(rankClass) div.classList.add(rankClass);

            div.innerHTML = `<div>${item.date} <small>(${item.mode})</small></div><div><span class="trophy-icon">${trophy}</span><b>${item.finalScore}åˆ†</b> ${item.result}</div>`;
            list.appendChild(div);
        });
    }

    function clearHistory() { 
        Swal.fire({ title: 'ç¢ºå®šæ¸…ç©ºï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'æ¸…ç©º' }).then((result) => {
            if (result.isConfirmed) { historyData = []; updateStorageAndUI(); Swal.fire('å·²åˆªé™¤', '', 'success'); }
        });
    }

    function exportToCSV() {
        if (historyData.length === 0) { Swal.fire('ç„¡è³‡æ–™', 'ç„¡æ³•åŒ¯å‡º', 'info'); return; }
        let csv = "æ—¥æœŸæ™‚é–“,æ¨¡å¼,æœ€çµ‚åˆ†æ•¸,çµæœ,åŸå§‹å¾—åˆ†,é²å»¶æ‰£åˆ†,3Cé•è¦æ‰£,3Cé•è¦æ¬¡,å°±å¯¢é•è¦æ‰£,å°±å¯¢çå‹µ,é‡å¤§é•è¦æ‰£,é‡å¤§é•è¦ç´°ç¯€,æ•¸å­¸,å…¶ä»–ç§‘,å¯«è€ƒå·,é«˜åˆ†è€ƒå·,ä¸åŠæ ¼ç§‘,>80åˆ†ç§‘,è‡ªè¨‚ä»»å‹™,Appä½¿ç”¨ç´€éŒ„\n";
        historyData.forEach(row => {
            const c = (t) => (t || "").toString().replace(/,/g, "ï¼Œ");
            csv += `${row.date},${row.mode},${row.finalScore},${row.result},${row.earnedScore||0},${row.timePenalty||0},${row.excessivePenalty||0},${row.excessiveCount||0},${row.bedtimePenalty||0},${row.bedtimeBonus||"-"},${row.violationPenalty||0},"${c(row.violationDetails)}",${c(row.math)},${c(row.others)},${row.tpCount||0},${row.tpHigh||0},${row.failedExams||0},${row.score80Exams||0},"${c(row.customs)}","${c(row.appLogStr)}"\n`;
        });
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `æ£®æ·®è¦ç¯„_${new Date().toISOString().split('T')[0]}.csv`; a.click();
    }

    function importFromCSV(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split("\n"); const newHistory = [];
            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].trim().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length >= 5) {
                    newHistory.push({
                        date: cols[0], mode: cols[1], finalScore: parseFloat(cols[2]), result: cols[3],
                        earnedScore: parseFloat(cols[4]), timePenalty: parseFloat(cols[5]), excessivePenalty: parseFloat(cols[6]),
                        excessiveCount: parseFloat(cols[7]), bedtimePenalty: parseFloat(cols[8]), bedtimeBonus: cols[9],
                        violationPenalty: parseFloat(cols[10]), violationDetails: cols[11].replace(/"/g, ''), math: cols[12], others: cols[13], 
                        tpCount: parseFloat(cols[14])||0, tpHigh: parseFloat(cols[15])||0,
                        failedExams: parseFloat(cols[16])||0, score80Exams: parseFloat(cols[17])||0,
                        customs: cols[18].replace(/"/g, ''),
                        appLogStr: cols[19] ? cols[19].replace(/"/g, '') : "ç„¡"
                    });
                }
            }
            if(newHistory.length > 0) { 
                Swal.fire({ title: `è®€å–åˆ° ${newHistory.length} ç­†è³‡æ–™`, text: "è¦è¦†è“‹é‚„æ˜¯åˆä½µï¼Ÿ", icon: 'question', showDenyButton: true, showCancelButton: true, confirmButtonText: 'è¦†è“‹', denyButtonText: 'åˆä½µ' }).then((result) => {
                    if (result.isConfirmed) { historyData = newHistory; updateStorageAndUI(); Swal.fire('å·²è¦†è“‹', '', 'success'); } 
                    else if (result.isDenied) { historyData = [...newHistory, ...historyData]; updateStorageAndUI(); Swal.fire('å·²åˆä½µ', '', 'success'); }
                });
            }
        };
        reader.readAsText(file); input.value = '';
    }
</script>

</body>
</html>
