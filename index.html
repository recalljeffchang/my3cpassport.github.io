<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.H. OPERATOR PROTOCOL (v45.1 ULTIMATE)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --df-gold: #f0b90b;
            --df-gold-glow: rgba(240, 185, 11, 0.6);
            --df-dark: #050505;
            --df-panel: #111;
            --df-gray: #333;
            --df-text: #e0e0e0;
            --df-red: #ff3333;
            --df-cyan: #00f3ff;
        }

        /* CRT Effect Overlay */
        .crt::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--df-dark);
            color: var(--df-text);
            margin: 0; padding: 0;
            overflow-x: hidden;
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            padding-bottom: 100px;
        }

        /* Boot Screen */
        #bootScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; font-family: 'Share Tech Mono', monospace;
            color: var(--df-gold);
        }
        .boot-text { font-size: 1.2rem; margin-bottom: 10px; opacity: 0; animation: fadeIn 0.2s forwards; }

        /* Lock Screen */
        #lockOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 0, 0, 0.95); z-index: 5000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            border: 5px solid var(--df-red);
        }
        .lock-icon { font-size: 4rem; margin-bottom: 20px; animation: pulseRed 1s infinite; }

        .container { max-width: 700px; margin: 0 auto; padding: 20px; opacity: 0; transition: opacity 1s; position: relative; z-index: 1;}
        .system-locked { pointer-events: none; filter: grayscale(1) contrast(1.2); opacity: 0.5; }

        /* HUD Header */
        .hud-header {
            border: 1px solid var(--df-gray); border-top: 4px solid var(--df-gold);
            background: rgba(20, 20, 20, 0.9); padding: 15px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 0 15px rgba(240, 185, 11, 0.1);
        }
        .rank-info { font-family: 'Share Tech Mono'; font-size: 0.8rem; color: #888; }
        .clock-display { font-family: 'Share Tech Mono'; color: var(--df-gold); font-size: 1.2rem; letter-spacing: 1px; }

        /* Cards */
        .card {
            background: rgba(20, 20, 20, 0.8); border: 1px solid var(--df-gray);
            margin-bottom: 15px; padding: 20px; position: relative;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }
        .card:hover { border-color: var(--df-gold); box-shadow: 0 0 10px rgba(240, 185, 11, 0.1); }
        .card-title { font-size: 1.1rem; color: var(--df-gold); margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 8px; display:flex; justify-content:space-between; }

        /* UI Elements */
        .task-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; margin-bottom: 5px; background: #0a0a0a; border: 1px solid #222;
            transition: 0.2s; cursor: pointer;
        }
        .task-item:hover { background: #151515; border-color: #444; }
        .task-item.active { border-color: var(--df-gold); background: rgba(240, 185, 11, 0.05); }
        
        .g-checkbox {
            width: 18px; height: 18px; border: 2px solid #555; display: inline-block;
            margin-right: 12px; position: relative; transition: 0.2s;
        }
        .task-item.active .g-checkbox { background: var(--df-gold); border-color: var(--df-gold); box-shadow: 0 0 8px var(--df-gold); }

        input, select {
            background: #000; border: 1px solid #444; color: #fff; padding: 8px;
            font-family: 'Chakra Petch'; font-size: 0.9rem; width: 100%; box-sizing: border-box;
            transition: 0.3s;
        }
        input:focus { border-color: var(--df-cyan); outline: none; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }

        .btn-game {
            background: #222; color: #fff; border: 1px solid #444; padding: 10px;
            font-family: 'Chakra Petch'; font-weight: 700; cursor: pointer;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-game:hover { border-color: var(--df-gold); color: var(--df-gold); }
        .btn-primary { background: var(--df-gold); color: #000; border: none; width: 100%; font-size: 1.1rem; padding: 15px; margin-top: 10px; }
        .btn-primary:hover { background: #ffcc00; color: #000; box-shadow: 0 0 20px var(--df-gold); }
        .btn-delete { border:1px solid var(--df-red); color:var(--df-red); background:transparent; width:auto; padding:5px 10px; font-size:0.7rem; }

        /* XP Bar */
        .xp-bar-container { height: 8px; background: #222; margin: 10px 0; border: 1px solid #444; }
        .xp-bar-fill { height: 100%; background: var(--df-gold); width: 0%; transition: width 0.5s; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseRed { 0% { opacity: 0.5; text-shadow: 0 0 10px red; } 100% { opacity: 1; text-shadow: 0 0 20px red; } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        
        .floating-text { position: fixed; color: var(--df-gold); font-weight: bold; pointer-events: none; animation: floatUp 1s forwards; z-index: 9999; text-shadow: 0 0 5px #000; font-size: 1.2rem;}
        
        .badge { font-size: 0.7rem; padding: 2px 6px; border: 1px solid; border-radius: 2px; }
        .badge-bonus { color: var(--df-cyan); border-color: var(--df-cyan); }
    </style>
</head>
<body class="crt">

<!-- Boot Screen -->
<div id="bootScreen">
    <div class="boot-text" style="animation-delay: 0.2s">> SYSTEM INITIALIZING...</div>
    <div class="boot-text" style="animation-delay: 0.6s">> CHECKING SECURITY PROTOCOLS...</div>
    <div class="boot-text" style="animation-delay: 1.0s">> RESTORING MODULES: [CLOCK] [CUSTOM] [HISTORY]</div>
    <div class="boot-text" style="animation-delay: 1.5s; color:var(--df-cyan)">> v45.1 UPDATE COMPLETE</div>
    <div class="boot-text" style="animation-delay: 1.8s; font-size: 0.8rem; margin-top:20px;">TOUCH TO START</div>
</div>

<!-- Lock Screen -->
<div id="lockOverlay">
    <div class="lock-icon">üîí</div>
    <h2 style="color:var(--df-red); letter-spacing: 5px;">SYSTEM LOCKED</h2>
    <p style="color:#aaa; font-family:'Share Tech Mono'">TIMELINE EXPIRED. AUTH REQUIRED.</p>
    <button class="btn-game" style="border-color:var(--df-red); color:var(--df-red); margin-top:20px;" onclick="unlockSystem()">COMMANDER OVERRIDE</button>
</div>

<div class="container" id="mainUI">
    <!-- Header -->
    <div class="hud-header">
        <div class="rank-info">
            <div>OPERATOR: <strong style="color:var(--df-gold)">SENHUAI</strong></div>
            <div id="rankDisplay">RANK: ROOKIE</div>
        </div>
        <div class="clock-display" id="liveClock">00:00:00</div>
    </div>

    <!-- Toolbar -->
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button class="btn-game" style="flex:1" onclick="setMode('weekday')">üìÖ WEEKDAY</button>
        <button class="btn-game" style="flex:1" onclick="setMode('weekend')">‚öΩ WEEKEND</button>
        <button class="btn-game" style="flex:1" onclick="showHistory()">üìú DATA BANK</button>
    </div>

    <!-- Score Bar -->
    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
        <span style="font-size:0.8rem; color:#888;">MISSION PROGRESS</span>
        <span style="font-size:1.5rem; font-weight:bold; color:#fff;" id="scoreText">0 / 6</span>
    </div>
    <div class="xp-bar-container">
        <div class="xp-bar-fill" id="progressBar"></div>
    </div>

    <div id="gameContent">
        <!-- 1. ACADEMIC INTEL -->
        <div class="card">
            <div class="card-title">üìö ACADEMIC (Â≠∏Ê•≠) <span class="badge badge-bonus">BONUS</span></div>
            
            <div class="task-item" onclick="toggleTask('mathPassed', 2)">
                <div style="display:flex; align-items:center;">
                    <div class="g-checkbox"></div> <span>üìê MATH PASSED</span>
                </div>
                <span class="badge badge-bonus">+2</span>
                <input type="checkbox" id="mathPassed" style="display:none;">
            </div>

            <div class="input-row" style="margin-top:10px;">
                <input type="number" id="testPaperCount" placeholder="DRILLS (ÂºµÊï∏)" oninput="sfx.play('blip'); checkStatus()">
                <input type="number" id="testPaperHigh" placeholder="HIGH SCORE (>85)" oninput="sfx.play('blip'); checkStatus()">
            </div>
            
            <div class="input-row">
                <input type="number" id="otherExams" placeholder="OTHERS PASSED (+1/ea)" oninput="checkStatus()">
            </div>

            <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px; display:flex; gap:10px;">
                <input type="number" id="failedExams" placeholder="FAILED (‰∏çÂèäÊ†º)" style="border-color:var(--df-red); color:var(--df-red);" oninput="sfx.play('error'); checkStatus()">
                <input type="number" id="score80Exams" placeholder="ELITE (>80ÂàÜ)" style="border-color:var(--df-gold); color:var(--df-gold);" oninput="sfx.play('success'); checkStatus()">
            </div>
        </div>

        <!-- 2. CUSTOM MISSIONS (Restored) -->
        <div class="card">
            <div class="card-title">‚ú® SIDE MISSIONS (Ëá™Ë®Ç‰ªªÂãô)</div>
            <div class="input-row">
                <input type="text" id="customName" placeholder="MISSION NAME" style="flex:2">
                <input type="number" id="customPoints" placeholder="XP" value="1" style="flex:0.5">
                <button class="btn-game" onclick="addCustomTask()">ADD</button>
            </div>
            <div id="customTaskList"></div>
        </div>

        <!-- 3. TACTICAL OPS (Dynamic List) -->
        <div class="card">
            <div class="card-title"><span id="listTitle">DAILY OPS</span></div>
            <div id="taskList"></div>
        </div>

        <!-- 4. APP LOGS (With Plan) -->
        <div class="card">
            <div class="card-title">üì± EQUIPMENT LOGS</div>
            <div class="input-row">
                <input type="text" id="appName" placeholder="APP / GAME NAME" style="flex:2">
                <input type="number" id="appDuration" placeholder="USED(m)" style="flex:1">
                <input type="number" id="appPlanNext" placeholder="PLAN(m)" style="flex:1; border-color:var(--df-gold); color:var(--df-gold);">
            </div>
            <button class="btn-game" style="width:100%; border-color:var(--df-cyan); color:var(--df-cyan);" onclick="addAppLog()">+ LOG ENTRY</button>
            <div id="appLogList" style="margin-top:10px; font-size:0.85rem; color:#aaa;"></div>
        </div>

        <!-- 5. NIGHT OPS & PENALTIES (Restored) -->
        <div class="card" style="border-left: 2px solid var(--df-red);">
            <div class="card-title">üåô NIGHT OPS & INFRACTIONS</div>
            
            <div class="task-item" onclick="toggleTask('bedtimeBonus', 1)">
                <div style="display:flex; align-items:center;">
                    <div class="g-checkbox"></div> <span>üîã CHARGE AT BASE (ÂÆ¢Âª≥ÂÖÖÈõª)</span>
                </div>
                <span class="badge badge-bonus">+1</span>
                <input type="checkbox" id="bedtimeBonus" style="display:none;">
            </div>

            <div class="task-item" onclick="toggleTask('bedtimePenalty', 0)"> <!-- 0 here, handled in calc -->
                <div style="display:flex; align-items:center; color:var(--df-red);">
                    <div class="g-checkbox" style="border-color:var(--df-red)"></div> <span>üõå UNAUTHORIZED USE (ÂÅ∑Áé©)</span>
                </div>
                <span class="badge badge-penalty">-2</span>
                <input type="checkbox" id="bedtimePenalty" style="display:none;">
            </div>

            <hr style="border:0; border-top:1px dashed #333; margin:15px 0;">

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                 <span>‚è≥ DELAY (MINS)</span>
                 <input type="number" id="overtimeMinutes" value="0" oninput="checkStatus()" style="width:80px; border-color:var(--df-red);">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                 <span>üö´ VIOLATION (TIMES)</span>
                 <input type="number" id="excessiveCount" value="0" oninput="checkStatus()" style="width:80px; border-color:var(--df-red);">
            </div>
        </div>

        <div id="resultBox" style="display:none; text-align:center; padding:10px; border:1px solid #444; margin-bottom:10px;"></div>

        <button id="btnSave" class="btn-game btn-primary" onclick="submitReport()">üìù SUBMIT REPORT</button>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
             <button class="btn-game" style="font-size:0.7rem;" onclick="saveDraft()">üíæ SAVE DRAFT</button>
             <button class="btn-game" style="font-size:0.7rem; color:#666;" onclick="clearForm()">üóëÔ∏è RESET</button>
        </div>
    </div>
</div>

<!-- Hidden PDF Template -->
<div id="pdfTemplate" style="display:none; font-family:sans-serif; padding:20px;">
    <h1 style="border-bottom:2px solid #000;">S.H. OPERATOR LOG</h1>
    <p>DATE: <span id="pdfDate"></span> | SCORE: <span id="pdfScore"></span></p>
    <div id="pdfContent"></div>
    <div style="margin-top:50px; display:flex; justify-content:space-between;">
        <span>COMMANDER: ___________</span><span>OPERATOR: ___________</span>
    </div>
</div>

<script>
    /* --- CONFIG & STATE --- */
    const PARENT_PWD = "jeffjasmine"; 
    const TARGET_SCORE = 6;
    let currentMode = 'weekday';
    let appLogs = [];
    let customTasks = [];
    let isLocked = false;
    let totalXP = parseInt(localStorage.getItem('senhuai_total_xp_v45') || '0');

    /* --- AUDIO SYSTEM (Simplified) --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sfx = {
        play: (type) => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if(type==='click') { osc.type='square'; osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(1200,now+0.1); gain.gain.setValueAtTime(0.05,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
            if(type==='success') { osc.type='sine'; osc.frequency.setValueAtTime(500,now); osc.frequency.linearRampToValueAtTime(1000,now+0.2); gain.gain.setValueAtTime(0.1,now); gain.gain.linearRampToValueAtTime(0,now+0.3); osc.start(now); osc.stop(now+0.3); }
            if(type==='error') { osc.type='sawtooth'; osc.frequency.setValueAtTime(150,now); gain.gain.setValueAtTime(0.1,now); gain.gain.linearRampToValueAtTime(0,now+0.3); osc.start(now); osc.stop(now+0.3); }
            if(type==='blip') { osc.type='triangle'; osc.frequency.setValueAtTime(600,now); gain.gain.setValueAtTime(0.02,now); gain.gain.linearRampToValueAtTime(0,now+0.05); osc.start(now); osc.stop(now+0.05); }
        }
    };

    /* --- INITIALIZATION --- */
    window.onload = function() {
        const boot = document.getElementById('bootScreen');
        boot.onclick = () => {
            sfx.play('success');
            boot.style.opacity = '0';
            setTimeout(() => { boot.style.display='none'; document.getElementById('mainUI').style.opacity='1'; }, 500);
        };
        
        // Auto-detect mode
        const day = new Date().getDay();
        if(day === 0 || day === 6) setMode('weekend'); else setMode('weekday');

        updateClock();
        setInterval(updateClock, 1000);
        renderRank();
        
        // Check for draft
        const draft = localStorage.getItem('senhuai_draft_v45_1');
        if(draft) loadDraft(JSON.parse(draft));
    };

    /* --- CLOCK & LOCK --- */
    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').innerText = now.toLocaleTimeString('en-GB');
        
        const h = now.getHours(), m = now.getMinutes(), d = now.getDay();
        const isLate = (d===5 || d===6); // Fri/Sat
        const limitH = isLate ? 23 : 22;
        const limitM = 30;

        // Auto Lock Logic
        if (!isLocked && (h > limitH || (h === limitH && m >= limitM))) {
            lockSystem();
        }
    }

    function lockSystem() {
        isLocked = true;
        document.getElementById('lockOverlay').style.display = 'flex';
        document.getElementById('mainUI').classList.add('system-locked');
    }

    function unlockSystem() {
        Swal.fire({
            title: 'SECURITY CLEARANCE',
            input: 'password',
            background: '#000', color: '#fff',
            confirmButtonColor: 'var(--df-red)',
            confirmButtonText: 'UNLOCK'
        }).then((res) => {
            if(res.value === PARENT_PWD) {
                isLocked = false;
                document.getElementById('lockOverlay').style.display = 'none';
                document.getElementById('mainUI').classList.remove('system-locked');
                sfx.play('success');
            } else {
                sfx.play('error');
            }
        });
    }

    /* --- TASKS LOGIC --- */
    const baseTasks = {
        weekday: [
            { id: 'w1', text: 'üìñ STUDY (ËÆÄÊõ∏ 1hr)', pts: 1 },
            { id: 'w2', text: 'üí§ SLEEP (Áù°Áú† 7.5hr)', pts: 1 },
            { id: 'w3', text: 'üç± LUNCH BOX (Ê¥ó‰æøÁï∂)', pts: 1 },
            { id: 'w4', text: 'üöø SHOWER (Ê¥óÊæ°)', pts: 1 },
            { id: 'w5', text: 'üçΩÔ∏è DISHES (Ê¥óÁ¢ó)', pts: 1 },
            { id: 'w6', text: 'üóëÔ∏è TRASH (ÂûÉÂúæ)', pts: 1 }
        ],
        weekend: [
            { id: 'e1', text: '‚öΩ OUTDOOR (ÈÅãÂãï 1hr)', pts: 1 },
            { id: 'e2', text: 'üçö MEALS (Ê≠£Â∏∏‰∏âÈ§ê)', pts: 1 },
            { id: 'e3', text: 'üëï CLOSET (Êï¥ÁêÜË°£Ê´É)', pts: 1 },
            { id: 'e4', text: 'üõèÔ∏è ROOM CLEAN (Êï¥ÊΩî)', pts: 1 },
            { id: 'e5', text: 'üß∫ LAUNDRY (ÊäòË°£Êúç)', pts: 1 }
        ]
    };

    function setMode(mode) {
        currentMode = mode;
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        const items = mode==='weekday' ? baseTasks.weekday : [...baseTasks.weekday, ...baseTasks.weekend];
        
        items.forEach(t => {
            const div = document.createElement('div');
            div.className = 'task-item';
            div.setAttribute('onclick', `toggleTask('${t.id}', ${t.pts})`);
            div.innerHTML = `<div style="display:flex; align-items:center;"><div class="g-checkbox"></div><span>${t.text}</span></div><span class="badge badge-bonus">+${t.pts}</span><input type="checkbox" id="${t.id}" value="${t.pts}" style="display:none;">`;
            list.appendChild(div);
        });
        document.getElementById('listTitle').innerText = mode==='weekday'?'DAILY OPS (Êó•Â∏∏)':'JOINT OPS (ÂÅáÊó•)';
        sfx.play('blip');
        checkStatus();
    }

    function toggleTask(id, pts) {
        if(isLocked) return;
        const chk = document.getElementById(id);
        chk.checked = !chk.checked;
        const parent = chk.closest('.task-item');
        if(chk.checked) {
            parent.classList.add('active');
            sfx.play('click');
            showFloatingText(`+${pts} XP`, event.clientX, event.clientY);
        } else {
            parent.classList.remove('active');
        }
        checkStatus();
    }

    /* --- CUSTOM TASKS --- */
    function addCustomTask() {
        const name = document.getElementById('customName').value;
        const pts = parseInt(document.getElementById('customPoints').value) || 0;
        if(!name) return;
        
        const id = 'cust_' + Date.now();
        customTasks.push({id, name, pts});
        renderCustomTasks();
        document.getElementById('customName').value = '';
        sfx.play('blip');
    }

    function renderCustomTasks() {
        const div = document.getElementById('customTaskList');
        div.innerHTML = '';
        customTasks.forEach(t => {
            const el = document.createElement('div');
            el.className = 'task-item';
            el.innerHTML = `<div style="display:flex;align-items:center;width:100%" onclick="toggleTask('${t.id}', ${t.pts})"><div class="g-checkbox"></div><span>${t.name}</span></div><span class="badge badge-bonus">+${t.pts}</span><button class="btn-delete" onclick="removeCustomTask('${t.id}')">‚úï</button><input type="checkbox" id="${t.id}" value="${t.pts}" style="display:none;">`;
            div.appendChild(el);
        });
    }
    function removeCustomTask(id) { customTasks = customTasks.filter(t=>t.id!==id); renderCustomTasks(); checkStatus(); }

    /* --- APP LOGS --- */
    function addAppLog() {
        const name = document.getElementById('appName').value;
        const dur = document.getElementById('appDuration').value;
        const plan = document.getElementById('appPlanNext').value;
        if(!name) return;
        appLogs.push({name, dur, plan});
        renderAppLogs();
        document.getElementById('appName').value = ''; document.getElementById('appDuration').value = ''; document.getElementById('appPlanNext').value = '';
        sfx.play('blip');
    }
    function renderAppLogs() {
        document.getElementById('appLogList').innerHTML = appLogs.map(a => `<div>> ${a.name} (${a.dur}m) [Next: ${a.plan}m]</div>`).join('');
    }

    function showFloatingText(text, x, y) {
        const el = document.createElement('div');
        el.className = 'floating-text'; el.innerText = text; el.style.left=x+'px'; el.style.top=y+'px';
        document.body.appendChild(el);
        setTimeout(()=>el.remove(),1000);
    }

    /* --- CALCULATIONS --- */
    function checkStatus() {
        let earned = 0;
        // Academic
        if(document.getElementById('mathPassed').checked) earned += 2;
        earned += (parseInt(document.getElementById('otherExams').value) || 0);
        const drillCount = parseInt(document.getElementById('testPaperCount').value) || 0;
        const drillHigh = parseInt(document.getElementById('testPaperHigh').value) || 0;
        earned += (drillCount * 1) + (drillHigh * 2);

        // Tasks
        document.querySelectorAll('#taskList input:checked').forEach(c => earned += parseInt(c.value));
        customTasks.forEach(t => { if(document.getElementById(t.id)?.checked) earned += t.pts; });
        
        // Bedtime
        if(document.getElementById('bedtimeBonus').checked) earned += 1;

        // Penalties
        let penalty = 0;
        if(document.getElementById('bedtimePenalty').checked) penalty += 2;
        const failed = parseInt(document.getElementById('failedExams').value) || 0; // Failed doesn't minus points directly in score but affects rank logic, though original v43/44 did minus? Let's strictly follow v44 logic: v44 didn't minus points for fail, but REQUIRED app logs. 
        // Wait, looking at user provided file v44: "ÈÅïË¶èÂ∞áÊâ£Èô§ÂàÜÊï∏". 
        // Let's apply generic penalty for infractions.
        const late = parseInt(document.getElementById('overtimeMinutes').value) || 0;
        if(late>0) {
            if(late<5) penalty+=1; else if(late<10) penalty+=2; else penalty += (2 + Math.ceil((late-10)/5));
        }
        const violations = parseInt(document.getElementById('excessiveCount').value) || 0;
        penalty += violations;

        const finalScore = earned - penalty;
        
        // Update UI
        document.getElementById('scoreText').innerText = `${finalScore} / ${TARGET_SCORE}`;
        const pct = Math.min(100, Math.max(0, (finalScore/TARGET_SCORE)*100));
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressBar').style.backgroundColor = finalScore>=6 ? 'var(--df-cyan)' : 'var(--df-gold)';

        // Requirement Check
        const resultBox = document.getElementById('resultBox');
        const elite = (parseInt(document.getElementById('score80Exams').value)||0) > 0;
        let msg = "";
        
        if (failed > 0) { msg = "<span style='color:red'>FAILED EXAM DETECTED. APP LOGS REQUIRED.</span>"; }
        else if (elite) { msg = "<span style='color:var(--df-cyan)'>ELITE STATUS. EXEMPTION GRANTED.</span>"; }
        else if (finalScore >= 9) { msg = "<span style='color:var(--df-gold)'>LEGENDARY PERFORMANCE.</span>"; }
        
        if(msg) { resultBox.style.display='block'; resultBox.innerHTML = msg; } else { resultBox.style.display='none'; }

        return { finalScore, passed: finalScore >= TARGET_SCORE, elite, failed };
    }

    /* --- SAVE & SUBMIT --- */
    function submitReport() {
        const status = checkStatus();
        
        // Validation
        if (status.failed > 0 && appLogs.length === 0) {
             Swal.fire({icon:'error', title:'MISSING DATA', text:'Failed exams require Equipment Logs.', background:'#000', color:'#fff'});
             return;
        }

        // Parent Auth for Submit (Optional, but good for game feel)
        Swal.fire({
            title: 'CONFIRM UPLOAD?',
            text: `FINAL SCORE: ${status.finalScore}`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'EXECUTE',
            confirmButtonColor: 'var(--df-gold)',
            background: '#000', color: '#fff'
        }).then((res) => {
            if(res.isConfirmed) {
                // Save History
                const record = { date: new Date().toLocaleString(), score: status.finalScore, mode: currentMode };
                let history = JSON.parse(localStorage.getItem('senhuai_history_data') || '[]');
                history.unshift(record);
                localStorage.setItem('senhuai_history_data', JSON.stringify(history));

                // XP & Rank
                if(status.finalScore > 0) {
                    totalXP += status.finalScore;
                    localStorage.setItem('senhuai_total_xp_v45', totalXP);
                    renderRank();
                }

                if(status.passed) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                sfx.play('success');
                
                // PDF
                generatePDF(record);
                localStorage.removeItem('senhuai_draft_v45_1');
            }
        });
    }

    function generatePDF(data) {
        const el = document.getElementById('pdfTemplate');
        document.getElementById('pdfDate').innerText = data.date;
        document.getElementById('pdfScore').innerText = data.score;
        
        let content = "<strong>COMPLETED OBJECTIVES:</strong><br>";
        document.querySelectorAll('input:checked').forEach(i => {
             content += `[x] ${i.nextElementSibling.innerText} (+${i.value})<br>`;
        });
        document.getElementById('pdfContent').innerHTML = content;

        el.style.display = 'block';
        html2pdf().from(el).save(`OPS_LOG_${Date.now()}.pdf`).then(() => el.style.display='none');
    }

    function saveDraft() {
        const data = {
            math: document.getElementById('mathPassed').checked,
            drillC: document.getElementById('testPaperCount').value,
            drillH: document.getElementById('testPaperHigh').value,
            others: document.getElementById('otherExams').value,
            failed: document.getElementById('failedExams').value,
            elite: document.getElementById('score80Exams').value,
            bedBonus: document.getElementById('bedtimeBonus').checked,
            bedPenalty: document.getElementById('bedtimePenalty').checked,
            late: document.getElementById('overtimeMinutes').value,
            vio: document.getElementById('excessiveCount').value,
            checks: Array.from(document.querySelectorAll('#taskList input:checked')).map(e=>e.id),
            cust: customTasks,
            logs: appLogs,
            mode: currentMode
        };
        localStorage.setItem('senhuai_draft_v45_1', JSON.stringify(data));
        sfx.play('blip');
        Swal.fire({toast:true, position:'top-end', title:'DRAFT SAVED', icon:'success', showConfirmButton:false, timer:1500, background:'#000', color:'#fff'});
    }

    function loadDraft(d) {
        if(d.mode) setMode(d.mode);
        if(d.math) toggleTask('mathPassed', 2);
        document.getElementById('testPaperCount').value = d.drillC;
        document.getElementById('testPaperHigh').value = d.drillH;
        document.getElementById('otherExams').value = d.others;
        document.getElementById('failedExams').value = d.failed;
        document.getElementById('score80Exams').value = d.elite;
        if(d.bedBonus) toggleTask('bedtimeBonus', 1);
        if(d.bedPenalty) toggleTask('bedtimePenalty', 0);
        document.getElementById('overtimeMinutes').value = d.late;
        document.getElementById('excessiveCount').value = d.vio;
        
        customTasks = d.cust || []; renderCustomTasks();
        appLogs = d.logs || []; renderAppLogs();
        
        if(d.checks) d.checks.forEach(id => {
            const el = document.getElementById(id);
            if(el && !el.checked) toggleTask(id, el.value);
        });
    }

    function renderRank() {
        const ranks = [
            {xp:0, n:'ROOKIE'}, {xp:50, n:'PRIVATE'}, {xp:150, n:'SPECIALIST'},
            {xp:300, n:'CORPORAL'}, {xp:500, n:'SERGEANT'}, {xp:800, n:'LIEUTENANT'}, {xp:1200, n:'COMMANDER'}
        ];
        let r = ranks[0];
        for(let i of ranks) if(totalXP >= i.xp) r = i;
        document.getElementById('rankDisplay').innerText = `RANK: ${r.n} (${totalXP} XP)`;
    }

    function showHistory() {
        const h = JSON.parse(localStorage.getItem('senhuai_history_data') || '[]');
        let html = h.map(x => `<div style="border-bottom:1px solid #333; padding:5px;">${x.date} - <strong>${x.score} XP</strong></div>`).join('');
        Swal.fire({
            title: 'DATA BANK',
            html: `<div style="max-height:300px; overflow-y:auto; text-align:left; font-family:'Share Tech Mono'">${html||'NO DATA'}</div>`,
            background: '#000', color: '#fff',
            showDenyButton: true, denyButtonText: 'EXPORT CSV', confirmButtonText: 'CLOSE'
        }).then(res => {
            if(res.isDenied) {
                let csv = "Date,Score,Mode\n" + h.map(x=>`${x.date},${x.score},${x.mode}`).join('\n');
                let blob = new Blob([csv], {type:'text/csv'});
                let url = URL.createObjectURL(blob);
                let a = document.createElement('a'); a.href=url; a.download='history.csv'; a.click();
            }
        });
    }
    
    function clearForm() { if(confirm('RESET?')) { localStorage.removeItem('senhuai_draft_v45_1'); location.reload(); } }
</script>
</body>
</html>
