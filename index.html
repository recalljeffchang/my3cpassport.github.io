<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.H. OPERATOR PROTOCOL (v44)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Delta Force Palette */
            --df-gold: #f0b90b;       /* Êà∞Ë°ìÈªÉ/Èáë */
            --df-gold-dim: #99780a;
            --df-dark: #0a0c10;       /* Ê•µÊ∑±ËóçÈªë */
            --df-panel: #14161a;      /* Èù¢ÊùøÂ∫ïËâ≤ */
            --df-gray: #2d343f;       /* ÈÇäÊ°ÜÁÅ∞ */
            --df-text: #e0e0e0;
            --df-red: #ff3b3b;        /* Ë≠¶ÂëäÁ¥Ö */
            --df-blue: #00e5ff;       /* ÁßëÊäÄËóç (Ë£ùÈ£æÁî®) */
            
            --clip-size: 15px;        /* ÂàáËßíÂ§ßÂ∞è */
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--df-dark);
            color: var(--df-text);
            margin: 0;
            padding: 20px;
            padding-bottom: 100px;
            /* Á∂≤Ê†ºËÉåÊôØ */
            background-image: 
                linear-gradient(rgba(10, 12, 16, 0.95), rgba(10, 12, 16, 0.95)),
                repeating-linear-gradient(0deg, transparent, transparent 19px, #222 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, #222 20px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
        }

        .container { max-width: 700px; margin: 0 auto; position: relative; z-index: 1; }

        /* Header Style */
        .header { 
            text-align: center; margin-bottom: 30px; position: relative; 
            border-bottom: 2px solid var(--df-gold); padding-bottom: 20px;
        }
        .header h1 { 
            color: var(--df-text); margin: 0; font-size: 1.8rem; letter-spacing: 2px; text-transform: uppercase; 
            text-shadow: 0 0 10px rgba(240, 185, 11, 0.3);
        }
        .header h1 span { color: var(--df-gold); }
        .header-sub {
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
            font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: #666;
        }
        .header-sub span { border: 1px solid #333; padding: 2px 8px; background: #000; }

        /* Definition Box */
        .definition-box {
            background: rgba(0, 229, 255, 0.05); border-left: 3px solid var(--df-blue);
            color: var(--df-blue); padding: 10px; font-size: 0.85rem; margin-top: 15px; text-align: left;
        }

        /* Êà∞Ë°ìÂç°Áâá (Tactical Card) */
        .card {
            background: var(--df-panel);
            border: 1px solid var(--df-gray);
            /* 45Â∫¶ÂàáËßí */
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - var(--clip-size)), 
                calc(100% - var(--clip-size)) 100%, 
                0 100%
            );
            padding: 25px; margin-bottom: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .card::after {
            /* Ë£ùÈ£æËßíËêΩ */
            content: ''; position: absolute; bottom: 0; right: 0; 
            width: var(--clip-size); height: 2px; background: var(--df-gold);
            transform: rotate(-45deg); transform-origin: 100% 100%;
        }
        .card.locked { opacity: 0.4; pointer-events: none; border-color: #333; }
        
        .card-title { 
            font-size: 1.1rem; color: var(--df-gold); margin-bottom: 20px; 
            border-left: 4px solid var(--df-gold); padding-left: 15px;
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Inputs */
        input[type="text"], input[type="number"], input[type="password"], select {
            background: #000; border: 1px solid var(--df-gray); color: #fff;
            padding: 12px; font-family: 'Chakra Petch', sans-serif;
            width: 100%; box-sizing: border-box; transition: 0.3s;
            text-transform: uppercase;
        }
        input:focus, select:focus { border-color: var(--df-gold); box-shadow: 0 0 5px rgba(240, 185, 11, 0.4); outline: none; }

        /* Tactical Buttons */
        .btn-game {
            background: #222; color: #fff; border: 1px solid var(--df-gray);
            padding: 12px; font-family: 'Chakra Petch', sans-serif; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-game:hover { background: #333; border-color: var(--df-text); }
        .btn-game:active { transform: scale(0.98); }
        
        .btn-primary { 
            background: var(--df-gold); color: #000; border: none; width: 100%; font-size: 1rem; 
            box-shadow: 0 0 10px rgba(240, 185, 11, 0.2);
        }
        .btn-primary:hover { background: #ffca28; box-shadow: 0 0 20px rgba(240, 185, 11, 0.6); color: #000;}

        /* Mode Selector */
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; border: 1px solid var(--df-gray); opacity: 0.6; }
        .mode-btn.active { 
            border: 1px solid var(--df-gold); opacity: 1; background: rgba(240, 185, 11, 0.1); 
            color: var(--df-gold); box-shadow: inset 0 0 10px rgba(240, 185, 11, 0.2);
        }

        /* Merits Bar (XP) */
        .xp-bar-container { background: #000; height: 10px; border-radius: 0; margin-bottom: 25px; border: 1px solid #333; position: relative; }
        .xp-bar-fill { background: var(--df-gold); height: 100%; width: 0%; transition: width 0.5s; box-shadow: 0 0 10px var(--df-gold); }
        .xp-text { text-align: right; color: var(--df-gold); font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; font-family: 'Roboto Mono'; }

        /* Task List */
        .task-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .task-item:last-child { border-bottom: none; }
        .task-group-title {
            color: #666; font-size: 0.75rem; margin: 15px 0 5px 0; letter-spacing: 1px;
            border-bottom: 1px solid var(--df-gray); padding-bottom: 5px;
        }
        
        /* Custom Checkbox */
        input[type="checkbox"] {
            appearance: none; width: 20px; height: 20px; border: 2px solid var(--df-gray);
            background: #000; cursor: pointer; position: relative; margin-right: 15px;
        }
        input[type="checkbox"]:checked { background: var(--df-gold); border-color: var(--df-gold); }
        input[type="checkbox"]:checked::after {
            content: '‚úì'; position: absolute; color: #000; font-size: 14px; top: -1px; left: 3px; font-weight: bold;
        }

        /* Badges */
        .badge { font-size: 0.7rem; padding: 3px 6px; border: 1px solid; margin-left: 8px; text-transform: uppercase;}
        .badge-point { border-color: var(--df-gold); color: var(--df-gold); }
        .badge-bonus { border-color: var(--df-blue); color: var(--df-blue); }
        .badge-penalty { border-color: var(--df-red); color: var(--df-red); }
        .badge-required { background: var(--df-red); color: #000; border: none; font-weight: bold; }
        .badge-exempt { background: var(--df-gold); color: #000; border: none; font-weight: bold; }

        /* Alert Box */
        .alert-box { 
            background: rgba(255, 59, 59, 0.1); border: 1px solid var(--df-red); color: var(--df-red); 
            padding: 15px; text-align: center; margin-bottom: 20px; display: none;
        }
        .info-box {
            background: rgba(240, 185, 11, 0.1); border: 1px solid var(--df-gold-dim); color: var(--df-gold);
            padding: 15px; margin-bottom: 20px; font-size: 0.85rem; line-height: 1.6;
        }

        /* Layout */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        /* App Log */
        .app-item { border-bottom: 1px solid #222; padding: 10px 0; color: #aaa; display:flex; justify-content:space-between;}
        .app-item span { color: var(--df-blue); }
        
        .quick-app-btn {
            background: #222; border: 1px solid #444; color: #888;
            padding: 5px 10px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
        }
        .quick-app-btn:hover { border-color: var(--df-gold); color: var(--df-gold); }
        
        /* Accordion */
        .accordion { background: #1a1a1a; color: #888; border: 1px solid #333; padding: 15px; width: 100%; text-align: left; cursor: pointer; margin-bottom: 10px; transition:0.3s;}
        .accordion:hover { color: var(--df-gold); border-color: var(--df-gold); }
        .panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #111; padding: 0 15px; border-left: 2px solid var(--df-gold); margin-bottom: 20px; }
        
        /* SweetAlert2 Delta Theme */
        div:where(.swal2-container).swal2-center>.swal2-popup { 
            background: #14161a; border: 2px solid var(--df-gold); color: #fff; 
            border-radius: 0; clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        div:where(.swal2-container) .swal2-title { color: var(--df-gold); font-family: 'Chakra Petch'; }
        div:where(.swal2-container) .swal2-confirm { background: var(--df-gold) !important; color: #000 !important; border-radius: 0 !important; }
        div:where(.swal2-container) .swal2-cancel { background: #333 !important; color: #fff !important; border-radius: 0 !important; }

        /* History */
        .history-item { background: #111; padding: 10px; border-left: 3px solid #333; margin-bottom: 5px; display:flex; justify-content:space-between; font-family:'Roboto Mono'; font-size:0.85rem;}
        .history-item.rank-1 { border-left-color: var(--df-gold); background: rgba(240, 185, 11, 0.1); }
        
        #pdfTemplate { display: none; } /* PDF Èö±Ëóè */
        
        .btn-delete { color: var(--df-red); background:none; border:none; cursor:pointer; font-weight:bold;}
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-sub">
            <span>OPERATOR: SENHUAI</span>
            <span id="liveClock">00:00:00</span>
        </div>
        <h1>S.H. <span>PROTOCOL</span></h1>
        <div style="font-size: 0.8rem; color: var(--df-text); letter-spacing: 5px; opacity: 0.7;">DAILY STATUS REPORT</div>
        
        <div class="definition-box">
            <strong>[INFO] CLASSIFIED DEVICES (3C):</strong><br>
            PHONE / TABLET / PC / TV
        </div>
    </div>

    <div id="lockBanner" class="alert-box">
        <h3>‚õî ACCESS DENIED (LOCKED)</h3>
        <p style="margin:5px 0;" id="lockMessage">TIMELINE EXPIRED.</p>
        <button class="btn-game" style="border-color:var(--df-red); color:var(--df-red);" onclick="unlockForm()">
            REQUEST COMMANDER OVERRIDE üîê
        </button>
    </div>

    <div class="time-rule-box info-box">
        <strong>üïí SUBMISSION DEADLINE (Êà™Ê≠¢ÊôÇÈñì)</strong>
        <ul style="margin: 5px 0 0 20px; padding: 0;">
            <li><strong>SUN - THU:</strong> 22:30 HOURS</li>
            <li><strong>FRI - SAT:</strong> 23:30 HOURS</li>
        </ul>
    </div>

    <button class="accordion">üìú MISSION BRIEFING (Êü•ÁúãË¶èÂâá)</button>
    <div class="panel">
        <div style="padding: 15px 0; color: #aaa;">
            <p><strong>OBJECTIVE:</strong> ÊØèÊó•Á¥ØÁ©ç <strong>6 MERITS</strong> ‰ª•Ëß£ÈéñÊòéÊó•Ë£ùÂÇô‰ΩøÁî®Ê¨ä„ÄÇ</p>
            <p><strong>EXEMPTION (ÂÖçÂ°´Ê¨ä):</strong> <br>1. ÂñÆÁßëÊàêÁ∏æ > 80 <br>2. Á∏ΩÂàÜ >= 9 <br>(‰∏îÁÑ°‰∏çÂèäÊ†º)</p>
            <p><strong>PENALTIES:</strong> ÈÅïË¶èÂ∞áÊâ£Èô§ÂàÜÊï∏ÔºåÂö¥ÈáçËÄÖÈúÄÊåáÊèÆÂÆò‰ªãÂÖ•„ÄÇ</p>
        </div>
    </div>

    <div id="mainForm">
        <div class="toolbar">
            <button class="btn-game btn-tool" onclick="saveDraft()">üíæ SAVE</button>
            <button class="btn-game btn-tool" onclick="loadDraft(true)">üìÇ LOAD</button>
            <button class="btn-game btn-tool" onclick="clearForm()">üóëÔ∏è CLEAR</button>
        </div>

        <div class="mode-selector">
            <button class="btn-game mode-btn active" onclick="setMode('weekday')">üìÖ WEEKDAY OPS</button>
            <button class="btn-game mode-btn" onclick="setMode('weekend')">‚öΩ WEEKEND OPS</button>
        </div>

        <div class="xp-text" id="progressText">0 / 6</div>
        <div class="xp-bar-container">
            <div class="xp-bar-fill" id="progressBar"></div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>üìö ACADEMIC INTEL (Â≠∏Ê•≠)</span>
                <span class="badge badge-bonus">BONUS</span>
            </div>
            
            <div class="task-item flex-between">
                <label style="cursor:pointer; display:flex; align-items:center;">
                    <input type="checkbox" id="mathPassed" onchange="checkStatus()"> 
                    <span>üìê MATH PASSED</span>
                </label>
                <span class="badge badge-bonus">+2</span>
            </div>
            
            <div class="task-item flex-between">
                <span>üìù OTHERS PASSED</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="number" id="otherExams" value="0" min="0" oninput="checkStatus()" style="width:50px; text-align:center;">
                    <span style="font-size:0.7rem;">(+1/SUB)</span>
                </div>
            </div>

            <div style="margin-top:15px; padding-top:10px; border-top: 1px dashed #333;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:8px;">üìä BATTLE DAMAGE ASSESSMENT (ÊàêÁ∏æÁµêÁÆó)</div>
                <div class="flex-row">
                    <div style="flex:1;">
                        <span style="color:var(--df-red); font-size:0.7rem; display:block; margin-bottom:5px;">üìâ FAILED (‰∏çÂèäÊ†º)</span>
                        <input type="number" id="failedExams" value="0" min="0" oninput="checkStatus()" style="border-color:var(--df-red); color:var(--df-red);">
                    </div>
                    <div style="flex:1;">
                        <span style="color:var(--df-gold); font-size:0.7rem; display:block; margin-bottom:5px;">üåü ELITE (>80ÂàÜ)</span>
                        <input type="number" id="score80Exams" value="0" min="0" oninput="checkStatus()" style="border-color:var(--df-gold); color:var(--df-gold);">
                    </div>
                </div>
            </div>

            <div style="margin-top:15px; padding-top:10px; border-top: 1px dashed #333;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:5px;">‚úçÔ∏è DRILLS (ËÄÉÂç∑Á∑¥Áøí)</div>
                <div class="task-item flex-between">
                    <span>COMPLETED</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="number" id="testPaperCount" value="0" min="0" oninput="checkStatus()" style="width:50px;">
                        <span class="badge badge-point">+1</span>
                    </div>
                </div>
                <div class="task-item flex-between">
                    <span>HIGH SCORE (>85)</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="number" id="testPaperHigh" value="0" min="0" oninput="checkStatus()" style="width:50px;">
                        <span class="badge badge-bonus">+2</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">‚ú® SIDE MISSIONS (Ëá™Ë®Ç‰ªªÂãô)</div>
            <div class="custom-input-area">
                <div class="input-row">
                    <input type="text" id="customName" placeholder="MISSION NAME">
                    <input type="number" id="customPoints" placeholder="PTS" value="1" min="0" style="flex:0.4">
                </div>
                <div class="flex-between" style="margin-top:10px;">
                    <label style="font-size:0.8rem; display:flex; align-items:center; color:var(--df-red);">
                        <input type="checkbox" id="customRequired"> PRIORITY (ÂøÖÂÅö)
                    </label>
                    <button class="btn-game" onclick="addCustomTask()" style="border-color:var(--df-gold); color:var(--df-gold); padding:5px 15px;">+ ADD</button>
                </div>
            </div>
            <div id="customTaskList"></div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>üì± EQUIPMENT LOGS <span id="appRequiredBadge" class="badge badge-required">REQUIRED</span></span>
                <button onclick="toggleAppHelp()" style="background:none; border:none; color:#666; cursor:pointer;">[?]</button>
            </div>
            <div id="appHelp" class="help-tip" style="background:#222; border:1px solid #444; color:#aaa; display:none; padding:10px; margin-bottom:10px; font-size:0.8rem;">
                CHECK SCREEN TIME IN SETTINGS.
            </div>
            
            <div class="app-input-area" style="background:rgba(0,0,0,0.3); border:1px solid #333; padding:15px;">
                <div class="quick-app-btn-group" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                    <button class="quick-app-btn" onclick="quickFillApp('YouTube')">YT</button>
                    <button class="quick-app-btn" onclick="quickFillApp('Roblox')">RBX</button>
                    <button class="quick-app-btn" onclick="quickFillApp('Instagram')">IG</button>
                    <button class="quick-app-btn" onclick="quickFillApp('TikTok')">TT</button>
                    <button class="quick-app-btn" style="border-color:#666;" onclick="addNoUsageLog()">üö´ NO USAGE</button>
                </div>
                
                <div class="input-row">
                    <select id="appDevice" style="flex:1; background:#000; color:#fff;">
                        <option value="POCO">üì± POCO</option>
                        <option value="iPad Mini">üçé MINI</option>
                        <option value="iPad 6">üçè IPAD6</option>
                    </select>
                    <input type="text" id="appName" placeholder="APP NAME" style="flex:2">
                </div>
                
                <div class="input-row">
                    <input type="number" id="appDuration" placeholder="USED (MIN)" min="0">
                    <input type="number" id="appPlanNext" placeholder="PLAN (MIN)" min="0" style="border-color:var(--df-gold); color:var(--df-gold);">
                </div>
                <button class="btn-game" style="width:100%; margin-top:10px;" onclick="addAppLog()">üìù LOG ENTRY</button>
            </div>
            
            <div id="appLogList" style="margin-top:10px;"></div>
            
            <div class="flex-between" style="margin-top:15px; font-size:0.8rem; color:#666; font-family:'Roboto Mono';">
                <div>USED: <span id="totalAppTime" style="color:var(--df-text)">0</span> m</div>
                <div>PLAN: <span id="totalPlanTime" style="color:var(--df-gold)">0</span> m</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span id="listTitle">TACTICAL OBJECTIVES (Êó•Â∏∏)</span>
            </div>
            <div id="taskList"></div>
        </div>

        <div class="card" style="border-left: 3px solid var(--bedtime-border);">
            <div class="card-title" style="color: #ba68c8;">üåô NIGHT OPS (Â∞±ÂØ¢)</div>
            <div class="task-item flex-between">
                <label style="cursor:pointer; display:flex; align-items:center;">
                    <input type="checkbox" id="bedtimeBonus" onchange="checkStatus()"> 
                    <span>üîã CHARGE AT BASE (ÂÆ¢Âª≥ÂÖÖÈõª)</span>
                </label>
                <span class="badge badge-bonus">+1</span>
            </div>
            <div class="task-item flex-between">
                <label style="cursor:pointer; display:flex; align-items:center; color:var(--df-red);">
                    <input type="checkbox" id="bedtimePenalty" onchange="checkStatus()"> 
                    <span>üõå UNAUTHORIZED USE (ÂÅ∑Áé©)</span>
                </label>
                <span class="badge badge-penalty">-2</span>
            </div>
        </div>

        <div class="card" style="border-left: 3px solid var(--df-red);">
            <div class="card-title" style="color: var(--df-red);">üö´ INFRACTIONS (ÈÅïË¶è)</div>
            
            <div style="margin-bottom: 20px;">
                <div style="color:#888; font-size:0.8rem; margin-bottom:5px;">‚è≥ DELAY VIOLATION (ÊãñÂª∂)</div>
                <div class="penalty-input-group flex-between">
                    <div style="display:flex; align-items:center; gap:10px;">
                         <input type="number" id="overtimeMinutes" value="0" min="0" oninput="checkStatus()" style="width:80px;">
                         <span style="font-size:0.8rem; color:#666;">MINS</span>
                    </div>
                    <span style="color: var(--df-red); font-weight:bold;">-<span id="penaltyPoints">0</span></span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="color:#888; font-size:0.8rem; margin-bottom:5px;">üì± OVERUSE / UNAPPROVED (Êø´Áî®)</div>
                <div class="penalty-input-group flex-between">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="number" id="excessiveCount" value="0" min="0" oninput="checkStatus()" style="width:80px;">
                        <span style="font-size:0.8rem; color:#666;">TIMES</span>
                    </div>
                    <span style="color: var(--df-red); font-weight:bold;">-<span id="excessivePenalty">0</span></span>
                </div>
            </div>

            <hr style="border:0; border-top:1px dashed #333; margin:15px 0;">

            <div>
                <div class="card-title" style="color:var(--df-red); font-size:0.9rem; border:none; padding:0;">üëÆ COMMANDER AUTH (ÂÆ∂Èï∑Á∞ΩÊ†∏)</div>
                <div class="parent-auth-area" style="background:#1a0505; border:1px solid var(--df-red); padding:15px; margin-top:10px;">
                    <div style="display:flex; gap:20px; justify-content:center; margin-bottom:15px;">
                        <label style="cursor:pointer; color:#aaa;"><input type="radio" name="violationStatus" value="none" onclick="toggleViolationInput(false)"> ‚≠ï CLEAN</label>
                        <label style="cursor:pointer; color:var(--df-red);"><input type="radio" name="violationStatus" value="exist" onclick="toggleViolationInput(true)"> ‚ùå VIOLATION</label>
                    </div>

                    <div id="violationInputZone" style="display:none; border-top:1px dashed #555; padding-top:15px;">
                        <div class="input-row">
                            <input type="text" id="violationName" placeholder="REASON">
                            <input type="number" id="violationPoints" placeholder="DEMERIT" value="1" min="1" style="flex:0.5">
                        </div>
                        <button class="btn-game" style="width:100%; border-color:var(--df-red); color:var(--df-red); margin-top:5px;" onclick="addMajorViolation()">REPORT INCIDENT</button>
                        <div id="violationList" style="margin-top:10px;"></div>
                    </div>

                    <div style="margin-top:15px;">
                        <input type="password" id="parentPwd" placeholder="üîë COMMANDER PASSCODE" style="border-color:#555;">
                    </div>
                </div>
            </div>
        </div>

        <div id="resultArea" class="result-box"></div>
        <button id="btnSave" class="btn-game btn-primary" style="margin-top:20px; font-size:1.1rem;" onclick="saveAndGeneratePDF()">üìù SUBMIT REPORT</button>
    </div>

    <div class="card" style="margin-top: 30px;">
        <div class="card-title">üèÜ HALL OF FAME (Ê¶ÆË≠ΩÊ¶ú)</div>
        <div class="csv-actions" style="margin-bottom:10px; display:flex; gap:10px;">
            <button class="btn-game" style="flex:1; font-size:0.7rem;" onclick="exportToCSV()">üì§ EXPORT CSV</button>
            <button class="btn-game" style="flex:1; font-size:0.7rem; position:relative;">üì• IMPORT CSV <input type="file" id="csvFileInput" accept=".csv" onchange="importFromCSV(this)" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer;"></button>
        </div>
        <div id="historyList" class="history-log"></div>
        <button class="btn-game" style="width:100%; margin-top:10px; color:#666; border:none; font-size:0.7rem;" onclick="clearHistory()">üóëÔ∏è WIPE DATABASE</button>
    </div>
</div>

<div id="pdfTemplate" style="position:fixed; left:-9999px; top:0; width:210mm; background:white; color:#000; padding:20mm; font-family:sans-serif;">
    <h1 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">S.H. OPERATOR DAILY REPORT</h1>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <span id="pdfDate">DATE: --</span>
        <span id="pdfMode">MODE: --</span>
    </div>
    <div style="background:#eee; padding:20px; text-align:center; margin-bottom:30px;">
        <div>TOTAL MERITS</div>
        <div style="font-size:3em; font-weight:bold;" id="pdfFinalScore">0</div>
        <div id="pdfResultText">STATUS</div>
    </div>
    <h3>EARNED MERITS</h3>
    <div id="pdfEarnedList" style="border-top:1px solid #ccc; padding-top:10px;"></div>
    <h3 style="margin-top:30px;">PENALTIES</h3>
    <div id="pdfPenaltyList" style="border-top:1px solid #ccc; padding-top:10px;"></div>
    <div style="margin-top:50px; display:flex; justify-content:space-between;">
        <span>COMMANDER: _______________</span>
        <span>OPERATOR: _______________</span>
    </div>
</div>

<script>
    const PARENT_PWD = "jeffjasmine";

    // 1. Data (v43 Fix)
    const baseWeekdayTasks = [
        { id: 'w2', text: 'STUDY 1HR (ËÆÄÊõ∏)', points: 1 },
        { id: 'w3', text: 'SLEEP 7.5HR (Áù°Áú†)', points: 1 },
        { id: 'w4', text: 'HOMEWORK (ÂäüË™≤)', points: 1 },
        { id: 'w5', text: 'LUNCH BOX (Ê¥ó‰æøÁï∂)', points: 1 },
        { id: 'w6', text: 'SHOWER (Ê¥óÊæ°)', points: 1 },
        { id: 'w8', text: 'DISHES (Ê¥óÁ¢ó)', points: 1 },
        { id: 'w9', text: 'TRASH (ÂÄíÂûÉÂúæ)', points: 1 }
    ];
    const baseWeekendTasks = [
        { id: 'e1', text: 'OUTDOOR 1HR (ÈÅãÂãï)', points: 1 },
        { id: 'e2', text: 'MEALS (‰∏âÈ§ê)', points: 1 },
        { id: 'e3', text: 'CLOSET (Ë°£Ê´É)', points: 1 },
        { id: 'e4', text: 'BED CLEAN (Êï¥ÊΩî)', points: 1 },
        { id: 'e5', text: 'SHOWER EARLY (Êó©Ê¥óÊæ°)', points: 1 },
        { id: 'e6', text: 'LAUNDRY (ÊäòË°£Êúç)', points: 1 }
    ];
    
    const tasks = { 
        weekday: baseWeekdayTasks, 
        weekend: [...baseWeekdayTasks, ...baseWeekendTasks] 
    };

    const TARGET_SCORE = 6; 
    let currentMode = 'weekday';
    let historyData = [], customTasks = [], majorViolations = [], appUsageLogs = [];
    let isFormLocked = false, isUnlockedByParent = false, lastCelebratedScore = 5, isAppLogRequired = true;

    // 2. Init
    window.onload = function() {
        const today = new Date();
        const day = today.getDay();
        const saved = localStorage.getItem('senhuai_history_v44'); 
        if (saved) historyData = JSON.parse(saved);
        
        if (day === 0 || day === 6) setMode('weekend'); else setMode('weekday');
        
        renderHistory(); checkDeadline(); updateClock(); setInterval(updateClock, 1000);
        setupAccordion();

        if(localStorage.getItem('senhuai_draft_v44')) {
            Swal.fire({
                title: 'RESUME SESSION?', text: "Found unsaved data.", icon: 'question', background: '#14161a', color:'#fff',
                showCancelButton: true, confirmButtonText: 'LOAD', cancelButtonText: 'DISCARD'
            }).then((result) => { if (result.isConfirmed) loadDraft(); });
        }
    };

    function setupAccordion() {
        const acc = document.getElementsByClassName("accordion");
        for (let i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px";
            });
        }
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').innerText = now.toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        if(now.getSeconds() === 0) checkDeadline();
    }

    function checkDeadline() {
        const now = new Date();
        const day = now.getDay(); 
        const isLateNight = (day === 5 || day === 6);
        const deadlineHour = isLateNight ? 23 : 22;
        const deadlineMinute = 30;
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        let isOverdue = (currentHour > deadlineHour) || (currentHour === deadlineHour && currentMinute >= deadlineMinute);
        
        if (isOverdue && !isFormLocked && !isUnlockedByParent) lockForm(isLateNight);
    }

    function lockForm(isLateNight) {
        isFormLocked = true;
        document.getElementById('lockBanner').style.display = 'block';
        document.getElementById('lockMessage').innerHTML = `MISSION EXPIRED (${isLateNight?"23:30":"22:30"}).<br>REQUIRE AUTH.`;
        document.querySelectorAll('#mainForm .card').forEach(card => card.classList.add('locked'));
        document.getElementById('btnSave').disabled = true;
        document.getElementById('btnSave').innerText = '‚õî LOCKED';
    }

    function unlockForm() {
        Swal.fire({
            title: 'SECURITY CLEARANCE',
            input: 'password', inputPlaceholder: 'PASSCODE',
            background: '#14161a', color: '#fff',
            showCancelButton: true, confirmButtonText: 'ACCESS', cancelButtonText: 'ABORT',
            preConfirm: (pwd) => { if (pwd !== PARENT_PWD) Swal.showValidationMessage('ACCESS DENIED'); }
        }).then((result) => {
            if (result.isConfirmed) {
                isFormLocked = false; isUnlockedByParent = true;
                document.getElementById('lockBanner').style.display = 'none';
                document.querySelectorAll('#mainForm .card').forEach(card => card.classList.remove('locked'));
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSave').innerText = 'üìù SUBMIT REPORT';
                Swal.fire({icon:'success', title:'ACCESS GRANTED', background:'#14161a', color:'#fff', timer:1000, showConfirmButton:false});
            }
        });
    }

    // 3. Render
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        if(mode === 'weekday') {
            document.querySelectorAll('.mode-btn')[0].classList.add('active');
            document.getElementById('listTitle').innerText = "DAILY OPS (Êó•Â∏∏‰ªªÂãô)";
            renderTasks(tasks.weekday, false);
        } else {
            document.querySelectorAll('.mode-btn')[1].classList.add('active');
            document.getElementById('listTitle').innerText = "JOINT OPS (ÂÅáÊó•Á∂úÂêà)";
            renderTasks([], true);
        }
        checkStatus(); 
    }

    function renderTasks(taskList, showGroups) {
        const container = document.getElementById('taskList');
        container.innerHTML = '';
        if (showGroups) {
            const t1 = document.createElement('div'); t1.className='task-group-title'; t1.innerText='BASIC (Âπ≥Êó•)'; container.appendChild(t1);
            baseWeekdayTasks.forEach(task => container.appendChild(createTaskElement(task)));
            const t2 = document.createElement('div'); t2.className='task-group-title'; t2.innerText='BONUS (ÂÅáÊó•)'; container.appendChild(t2);
            baseWeekendTasks.forEach(task => container.appendChild(createTaskElement(task)));
        } else {
            taskList.forEach(task => container.appendChild(createTaskElement(task)));
        }
    }

    function createTaskElement(task) {
        const div = document.createElement('div'); div.className = 'task-item';
        div.innerHTML = `<label style="cursor:pointer; display:flex; align-items:center; width:100%"><input type="checkbox" id="${task.id}" value="${task.points}" onchange="checkStatus()"><span>${task.text}</span><span class="badge badge-point">+${task.points}</span></label>`;
        return div;
    }

    // --- Draft ---
    function saveDraft() {
        if(isFormLocked) { Swal.fire('LOCKED', '', 'error'); return; }
        const draft = {
            mathPassed: document.getElementById('mathPassed').checked,
            otherExams: document.getElementById('otherExams').value,
            failedExams: document.getElementById('failedExams').value,
            score80Exams: document.getElementById('score80Exams').value,
            testPaperCount: document.getElementById('testPaperCount').value,
            testPaperHigh: document.getElementById('testPaperHigh').value,
            bedtimeBonus: document.getElementById('bedtimeBonus').checked,
            bedtimePenalty: document.getElementById('bedtimePenalty').checked,
            overtimeMinutes: document.getElementById('overtimeMinutes').value,
            excessiveCount: document.getElementById('excessiveCount').value,
            customTasks, majorViolations, appUsageLogs, checkedTasks: [], customTasksChecked: []
        };
        document.querySelectorAll('#taskList input[type="checkbox"]').forEach(chk => { if(chk.checked) draft.checkedTasks.push(chk.id); });
        customTasks.forEach(t => { if(document.getElementById(t.id).checked) draft.customTasksChecked.push(t.id); });
        localStorage.setItem('senhuai_draft_v44', JSON.stringify(draft));
        Swal.fire({icon:'success', title:'GAME SAVED', background:'#14161a', color:'#fff', timer:1000, showConfirmButton:false});
    }

    function loadDraft(showMsg) {
        const saved = localStorage.getItem('senhuai_draft_v44');
        if(!saved) { if(showMsg) Swal.fire('NO SAVE DATA', '', 'info'); return; }
        const draft = JSON.parse(saved);
        document.getElementById('mathPassed').checked = draft.mathPassed;
        document.getElementById('otherExams').value = draft.otherExams;
        document.getElementById('failedExams').value = draft.failedExams || 0;
        document.getElementById('score80Exams').value = draft.score80Exams || 0;
        document.getElementById('testPaperCount').value = draft.testPaperCount;
        document.getElementById('testPaperHigh').value = draft.testPaperHigh;
        document.getElementById('bedtimeBonus').checked = draft.bedtimeBonus;
        document.getElementById('bedtimePenalty').checked = draft.bedtimePenalty;
        document.getElementById('overtimeMinutes').value = draft.overtimeMinutes;
        document.getElementById('excessiveCount').value = draft.excessiveCount;
        
        customTasks = draft.customTasks || []; majorViolations = draft.majorViolations || []; appUsageLogs = draft.appUsageLogs || [];
        renderCustomTasks(); renderMajorViolations(); renderAppLogs();
        
        setTimeout(() => {
            if(draft.checkedTasks) draft.checkedTasks.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
            if(draft.customTasksChecked) draft.customTasksChecked.forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
            checkStatus(); 
        }, 50);
        if(showMsg) Swal.fire({icon:'success', title:'GAME LOADED', background:'#14161a', color:'#fff', timer:1000, showConfirmButton:false});
    }

    function clearForm() {
        Swal.fire({title:'RESET?', background:'#14161a', color:'#fff', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'YES'}).then((result) => {
            if(result.isConfirmed) { localStorage.removeItem('senhuai_draft_v44'); location.reload(); }
        });
    }

    // --- App Logs ---
    function quickFillApp(appName) { document.getElementById('appName').value = appName; document.getElementById('appDuration').focus(); }
    function toggleAppHelp() { document.getElementById('appHelp').style.display = document.getElementById('appHelp').style.display==='block'?'none':'block'; }
    function addAppLog() {
        if(isFormLocked) return;
        const device = document.getElementById('appDevice').value;
        const name = document.getElementById('appName').value.trim();
        const duration = parseInt(document.getElementById('appDuration').value) || 0;
        const planNext = parseInt(document.getElementById('appPlanNext').value) || 0;
        if(!name) { Swal.fire('Error', 'ENTER NAME', 'warning'); return; }
        appUsageLogs.push({ id: 'app_' + Date.now(), device, name, duration, planNext });
        document.getElementById('appName').value = ''; document.getElementById('appDuration').value = ''; document.getElementById('appPlanNext').value = '';
        renderAppLogs();
    }
    function addNoUsageLog() {
        if(isFormLocked) return;
        appUsageLogs.push({ id: 'app_' + Date.now(), device: 'SYS', name: 'NO USAGE (AFK)', duration: 0, planNext: 0 });
        renderAppLogs();
    }
    function removeAppLog(id) { if(isFormLocked) return; appUsageLogs = appUsageLogs.filter(a => a.id !== id); renderAppLogs(); }
    function renderAppLogs() {
        const c = document.getElementById('appLogList'); c.innerHTML = '';
        let total = 0, totalPlan = 0;
        appUsageLogs.forEach(app => {
            total += app.duration; totalPlan += app.planNext || 0;
            const div = document.createElement('div'); div.className = 'app-item';
            div.innerHTML = `<div><small>[${app.device}]</small> ${app.name}</div><div style="display:flex;align-items:center;gap:10px;"><span>${app.duration}m</span><span style="color:var(--df-gold)">Plan:${app.planNext}</span><button class="btn-delete" onclick="removeAppLog('${app.id}')">‚úï</button></div>`;
            c.appendChild(div);
        });
        document.getElementById('totalAppTime').innerText = total; document.getElementById('totalPlanTime').innerText = totalPlan;
    }

    // --- Violation / Custom ---
    function addCustomTask() {
        if(isFormLocked) return;
        const name = document.getElementById('customName').value.trim();
        const points = parseInt(document.getElementById('customPoints').value) || 0;
        const required = document.getElementById('customRequired').checked;
        if(!name) { Swal.fire('Error', 'ENTER MISSION', 'warning'); return; }
        customTasks.push({ id: 'custom_' + Date.now(), text: name, points, required });
        document.getElementById('customName').value = ''; renderCustomTasks(); checkStatus();
    }
    function removeCustomTask(id) { if(isFormLocked) return; customTasks = customTasks.filter(t => t.id !== id); renderCustomTasks(); checkStatus(); }
    function renderCustomTasks() {
        const c = document.getElementById('customTaskList'); c.innerHTML = '';
        customTasks.forEach(t => {
            const div = document.createElement('div'); div.className = 'task-item';
            div.innerHTML = `<label style="cursor:pointer;display:flex;align-items:center;width:100%"><input type="checkbox" id="${t.id}" value="${t.points}" onchange="checkStatus()"><span>${t.text} ${t.required?'(MAIN)':''}</span><span class="badge badge-bonus">+${t.points}</span></label><button class="btn-delete" onclick="removeCustomTask('${t.id}')">‚úï</button>`;
            c.appendChild(div);
        });
    }

    function toggleViolationInput(show) {
        document.getElementById('violationInputZone').style.display = show ? 'block' : 'none';
        if(!show) { majorViolations = []; renderMajorViolations(); checkStatus(); }
    }
    function addMajorViolation() {
        if(isFormLocked) return;
        const name = document.getElementById('violationName').value.trim();
        const points = parseInt(document.getElementById('violationPoints').value) || 0;
        if(!name) { Swal.fire('Error', 'ENTER REASON', 'warning'); return; }
        majorViolations.push({ id: 'violation_' + Date.now(), text: name, points });
        document.getElementById('violationName').value = ''; renderMajorViolations(); checkStatus();
    }
    function removeMajorViolation(id) { if(isFormLocked) return; majorViolations = majorViolations.filter(v => v.id !== id); renderMajorViolations(); checkStatus(); }
    function renderMajorViolations() {
        const c = document.getElementById('violationList'); c.innerHTML = '';
        majorViolations.forEach(v => {
            const div = document.createElement('div'); div.className = 'violation-item';
            div.innerHTML = `<span>‚ö†Ô∏è ${v.text}</span><div style="display:flex;align-items:center;gap:10px;"><span class="badge badge-penalty">-${v.points}</span><button class="btn-delete" onclick="removeMajorViolation('${v.id}')">‚úï</button></div>`;
            c.appendChild(div);
        });
    }

    // --- Status ---
    function calculateTimePenalty() {
        const mins = parseInt(document.getElementById('overtimeMinutes').value) || 0;
        let points = 0;
        if(mins<5 && mins>0) points=1; else if(mins>=5 && mins<10) points=2; else if(mins>=10) points=2+(Math.floor((mins-10)/5)+1)*3;
        document.getElementById('penaltyPoints').innerText = points; return points;
    }

    function checkStatus() {
        let earnedScore = 0; let missingRequired = [];
        const failedExams = parseInt(document.getElementById('failedExams').value) || 0;
        const score80Exams = parseInt(document.getElementById('score80Exams').value) || 0;

        if (document.getElementById('mathPassed').checked) earnedScore += 2;
        earnedScore += (parseInt(document.getElementById('otherExams').value) || 0);
        const tpCount = parseInt(document.getElementById('testPaperCount').value) || 0;
        const tpHigh = parseInt(document.getElementById('testPaperHigh').value) || 0;
        earnedScore += tpCount * 1 + tpHigh * 2;

        document.querySelectorAll('#taskList input[type="checkbox"]:checked').forEach(chk => earnedScore += parseInt(chk.value));
        customTasks.forEach(t => {
            const el = document.getElementById(t.id);
            if(el && el.checked) earnedScore += t.points; else if(t.required) missingRequired.push(t.text);
        });
        if(document.getElementById('bedtimeBonus').checked) earnedScore += 1;

        const timePenalty = calculateTimePenalty();
        const excessiveCount = parseInt(document.getElementById('excessiveCount').value) || 0;
        const excessivePenalty = excessiveCount * 1;
        document.getElementById('excessivePenalty').innerText = excessivePenalty;
        let violationPenalty = 0; majorViolations.forEach(v => violationPenalty += v.points);
        let bedtimePenalty = 0; if (document.getElementById('bedtimePenalty').checked) bedtimePenalty = 2;

        const totalPenalty = timePenalty + excessivePenalty + violationPenalty + bedtimePenalty;
        let finalScore = earnedScore - totalPenalty;

        const badge = document.getElementById('appRequiredBadge');
        if (failedExams > 0) { isAppLogRequired = true; badge.innerText = 'REQUIRED (FAILED)'; badge.className = 'badge badge-penalty'; }
        else if (score80Exams > 0) { isAppLogRequired = false; badge.innerText = 'EXEMPT (ELITE)'; badge.className = 'badge badge-exempt'; }
        else if (finalScore >= 9) { isAppLogRequired = false; badge.innerText = 'EXEMPT (LEGEND)'; badge.className = 'badge badge-exempt'; }
        else { isAppLogRequired = true; badge.innerText = 'REQUIRED'; badge.className = 'badge badge-penalty'; }

        const percent = Math.min((earnedScore / TARGET_SCORE) * 100, 100);
        document.getElementById('progressBar').style.width = percent + '%';
        
        let statusText = "";
        if (earnedScore >= TARGET_SCORE) {
            statusText = `${earnedScore} / ${TARGET_SCORE} <span style="color:var(--neon-green)">[READY]</span>`;
            if(finalScore>lastCelebratedScore && missingRequired.length===0) { triggerCelebration(finalScore); lastCelebratedScore=finalScore; }
        } else {
            statusText = `${earnedScore} / ${TARGET_SCORE} <span style="color:var(--warning)">[PENDING]</span>`;
        }
        document.getElementById('progressText').innerHTML = statusText;

        renderResultBox(earnedScore, finalScore, missingRequired, totalPenalty);
        return { score: finalScore, earned: earnedScore, passed: (finalScore >= TARGET_SCORE && missingRequired.length === 0), missing: missingRequired, timePenalty, excessivePenalty, violationPenalty, bedtimePenalty, excessiveCount, tpCount, tpHigh, failedExams, score80Exams, appLogStr: appUsageLogs.map(a => `[${a.device}]${a.name}(${a.duration}m)`).join('|')||"N/A" };
    }

    function triggerCelebration(score) {
        let title = "OBJECTIVE UPDATED", icon = "info";
        if (score === 6) { title = "MISSION ACCOMPLISHED (6XP)"; icon="success"; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        else if (score >= 9) { title = "LEGENDARY STATUS (9XP+)"; icon="success"; confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors:['#f0b90b', '#fff'] }); }
        Swal.fire({ position: 'top-end', icon, title, showConfirmButton: false, timer: 2500, toast: true, background: '#14161a', color:'#fff' });
    }

    function renderResultBox(earned, final, missing, totalPenalty) {
        const r = document.getElementById('resultArea');
        r.style.display = 'block';
        if (final >= TARGET_SCORE && missing.length === 0) {
            r.innerHTML = `<div style="color:var(--neon-green); text-align:center; padding:10px; border:1px solid var(--neon-green);"><h3>‚úÖ MISSION SUCCESS</h3><p>SCORE: ${final}</p></div>`;
        } else {
            let msg = missing.length > 0 ? `MISSING: ${missing.join(', ')}` : "INSUFFICIENT XP";
            r.innerHTML = `<div style="color:var(--df-red); text-align:center; padding:10px; border:1px solid var(--df-red);"><h3>üö´ MISSION FAILED</h3><p>${msg}</p><p>SCORE: ${final}</p></div>`;
        }
    }

    // --- Save & PDF ---
    function saveAndGeneratePDF() {
        if(isFormLocked) { Swal.fire('LOCKED', '', 'error'); return; }
        if(isAppLogRequired && appUsageLogs.length === 0) { Swal.fire({icon:'warning', title:'LOGS REQUIRED', text:'Please log app usage or select AFK.', background:'#1e1e24', color:'#fff'}); return; }
        
        const vStatus = document.querySelector('input[name="violationStatus"]:checked');
        if(!vStatus) { Swal.fire({icon:'warning', title:'AUTH REQUIRED', text:'Commander verification needed.', background:'#1e1e24', color:'#fff'}); document.querySelector('.parent-auth-area').scrollIntoView({behavior:'smooth'}); return; }
        if(vStatus.value==='exist' && majorViolations.length===0) { Swal.fire('ERROR', 'Enter violation details.', 'error'); return; }
        
        const pwd = document.getElementById('parentPwd').value;
        if(pwd !== PARENT_PWD) { Swal.fire({icon:'error', title:'DENIED', text:'Invalid Passcode.', background:'#1e1e24', color:'#fff'}); return; }

        const status = checkStatus();
        const dateStr = new Date().toLocaleDateString('zh-TW');

        if(status.passed) {
            const tmr = new Date(); tmr.setDate(tmr.getDate()+1);
            const certHtml = `
                <div class="swal-certificate">
                    <div class="cert-icon">üéñÔ∏è</div>
                    <div class="cert-title">AUTHORIZATION GRANTED</div>
                    <div class="cert-body">OPERATOR <strong>SENHUAI</strong> CLEARED.<br>MERITS: ${status.score}</div>
                    <div class="cert-date">VALID: ${tmr.toLocaleDateString()}</div>
                    <div class="cert-stamp" style="border-color:var(--df-gold); color:var(--df-gold)">APPROVED</div>
                </div>
            `;
            Swal.fire({ html: certHtml, width: 600, padding: 0, showConfirmButton: true, confirmButtonText: 'ACKNOWLEDGED', backdrop: `rgba(0,0,0,0.9)`, background: '#fff' });
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors:['#f0b90b'] });
        } else {
            Swal.fire({title:'LOGGED', text:`Score: ${status.score}`, icon:'info', background:'#1e1e24', color:'#fff'});
        }

        // PDF Generation
        const el = document.getElementById('pdfTemplate');
        el.style.display = 'block'; 
        document.getElementById('pdfDate').innerText = `DATE: ${dateStr}`;
        document.getElementById('pdfFinalScore').innerText = status.score;
        document.getElementById('pdfResultText').innerText = status.passed ? "APPROVED" : "DENIED";
        
        let eList = "";
        if(document.getElementById('mathPassed').checked) eList += "<div>MATH (+2)</div>";
        document.querySelectorAll('#taskList input:checked').forEach(c => eList += `<div>${c.nextElementSibling.innerText} (+${c.value})</div>`);
        document.getElementById('pdfEarnedList').innerHTML = eList;

        const opt = { margin: 10, filename: `OPS_LOG_${dateStr}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } };
        html2pdf().set(opt).from(el).save().then(() => { el.style.display = 'none'; });

        const record = { date: new Date().toLocaleString(), mode: currentMode, finalScore: status.score, result: status.passed?"PASS":"FAIL", appLogStr: status.appLogStr };
        historyData.unshift(record);
        localStorage.setItem('senhuai_history_v44', JSON.stringify(historyData));
        localStorage.removeItem('senhuai_draft_v44');
        document.getElementById('parentPwd').value = '';
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('historyList'); list.innerHTML = '';
        // Sort Top 3
        let sorted = [...historyData].sort((a,b) => parseFloat(b.finalScore) - parseFloat(a.finalScore));
        let top3 = sorted.slice(0,3);
        let rest = historyData.filter(x => !top3.includes(x)).slice(0, 7);
        [...top3, ...rest].forEach(item => {
            const div = document.createElement('div'); div.className = 'history-item';
            let rank = top3.indexOf(item), trophy = rank===0?'ü•á':rank===1?'ü•à':rank===2?'ü•â':'';
            if(rank>=0) div.classList.add(`rank-${rank+1}`);
            div.innerHTML = `<div>${item.date}</div><div><span class="trophy">${trophy}</span><span style="color:${item.result==='PASS'?'var(--df-gold)':'var(--df-red)'}">${item.finalScore} XP</span></div>`;
            list.appendChild(div);
        });
    }

    function clearHistory() { if(confirm('WIPE?')) { historyData=[]; localStorage.setItem('senhuai_history_v44', '[]'); renderHistory(); } }
    function exportToCSV() { /* Standard CSV Logic */ }
    function importFromCSV(input) { /* Standard Import Logic */ }
</script>
</body>
</html>
